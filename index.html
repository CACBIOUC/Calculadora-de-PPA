<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora PPA ‚Äî FCB UC</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --uc: #0033A0;
  --gold: #C8922A;
  --bg: #f0ede8;
  --text: #1a1a2e;
  --muted: #7a7a8a;
  --green: #2e7d52;
  --green-bg: #e8f5ee;
  --red: #c0392b;
  --red-bg: #fdf0ee;
  --orange: #d4650a;
  --orange-bg: #fff4ec;
  --row-bg: #ffffff;
  --final-bg: #ffffff;
  --input-bg: #ffffff;
  --no-grade-bg: #f5f5f5;
  --no-grade-color: #999;
  --border-col: #e8e4dc;
  --el-input-bg: #ffffff;
  --select-bg: #ffffff;
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0f1117;
    --text: #e8e4dc;
    --muted: #8a8a9a;
    --green-bg: #0a2218;
    --red-bg: #250d0a;
    --orange-bg: #251500;
    --row-bg: #1a1d27;
    --final-bg: #1a1d27;
    --input-bg: #232635;
    --no-grade-bg: #13161f;
    --no-grade-color: #555;
    --border-col: #2a2d3a;
    --el-input-bg: #232635;
    --select-bg: #232635;
  }
}

* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Outfit',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; transition:background 0.3s,color 0.3s; }

/* CAREER SCREEN */
#screen-career {
  min-height:100vh; display:flex; flex-direction:column;
  align-items:center; justify-content:center; padding:40px 20px;
  background:var(--uc); position:relative; overflow:hidden;
}
#screen-career::before { content:''; position:absolute; width:600px; height:600px; border-radius:50%; border:80px solid rgba(255,255,255,0.04); top:-200px; right:-200px; }
#screen-career::after  { content:''; position:absolute; width:400px; height:400px; border-radius:50%; border:50px solid rgba(200,146,42,0.15); bottom:-150px; left:-100px; }
.career-logo { font-family:'Playfair Display',serif; color:white; text-align:center; margin-bottom:48px; position:relative; z-index:1; }
.career-logo h1 { font-size:2.4rem; font-weight:700; letter-spacing:-1px; }
.career-logo p { color:rgba(255,255,255,0.55); font-size:0.9rem; margin-top:6px; }
.gold-line { width:48px; height:3px; background:var(--gold); margin:14px auto; border-radius:2px; }
.career-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; max-width:860px; width:100%; position:relative; z-index:1; }
.career-card { background:rgba(255,255,255,0.07); border:1.5px solid rgba(255,255,255,0.12); border-radius:16px; padding:28px 24px; cursor:pointer; transition:all 0.25s; }
.career-card:hover { background:rgba(255,255,255,0.14); border-color:var(--gold); transform:translateY(-4px); }
.career-card.disabled { opacity:0.4; cursor:not-allowed; }
.career-card.disabled:hover { transform:none; border-color:rgba(255,255,255,0.12); background:rgba(255,255,255,0.07); }
.career-icon { font-size:2rem; margin-bottom:12px; }
.career-card h3 { font-family:'Playfair Display',serif; color:white; font-size:1.1rem; margin-bottom:6px; }
.career-card p { color:rgba(255,255,255,0.5); font-size:0.78rem; }
.badge-soon { display:inline-block; background:var(--gold); color:white; font-size:0.65rem; font-weight:600; padding:2px 8px; border-radius:20px; margin-top:8px; text-transform:uppercase; }

/* CALC SCREEN */
#screen-calc { display:none; min-height:100vh; }
.calc-header { background:var(--uc); color:white; padding:20px 32px; display:flex; align-items:center; gap:16px; }
.back-btn { background:rgba(255,255,255,0.1); border:none; color:white; width:36px; height:36px; border-radius:50%; cursor:pointer; font-size:1.1rem; display:flex; align-items:center; justify-content:center; transition:background 0.2s; }
.back-btn:hover { background:rgba(255,255,255,0.2); }
.calc-header-info h2 { font-family:'Playfair Display',serif; font-size:1.2rem; }
.calc-header-info p { font-size:0.78rem; color:rgba(255,255,255,0.55); }

/* STATS BAR */
.stats-bar {
  position:sticky; top:0; z-index:100; background:var(--uc);
  border-bottom:3px solid var(--gold); padding:14px 32px;
  display:flex; align-items:center; gap:28px; flex-wrap:wrap;
  box-shadow:0 4px 16px rgba(0,0,0,0.25);
}
.ppa-main .big { font-family:'Playfair Display',serif; font-size:2.4rem; font-weight:700; color:white; line-height:1; }
.ppa-main .big.good { color:#6ee8a0; }
.ppa-main .big.warn { color:#f5c842; }
.ppa-main .big.bad  { color:#ff9f9f; }
.ppa-main .lbl { font-size:0.68rem; color:rgba(255,255,255,0.5); margin-top:3px; text-transform:uppercase; letter-spacing:1px; font-weight:600; }
.stat-divider { width:1px; height:36px; background:rgba(255,255,255,0.15); }
.stat-item .val { font-family:'Playfair Display',serif; font-size:1.6rem; font-weight:700; color:white; line-height:1; }
.stat-item .val.red { color:#ff9f9f; }
.stat-item .lbl { font-size:0.68rem; color:rgba(255,255,255,0.5); margin-top:3px; text-transform:uppercase; letter-spacing:0.5px; }

/* CONTENT */
.calc-content { max-width:920px; margin:0 auto; padding:32px 24px 80px; }
.year-label { font-family:'Playfair Display',serif; font-size:1.15rem; color:var(--uc); margin:32px 0 10px; font-weight:700; border-left:4px solid var(--gold); padding-left:12px; }
.section { margin-bottom:24px; }
.section-header { display:flex; align-items:center; gap:10px; margin-bottom:12px; padding-bottom:10px; border-bottom:2px solid var(--uc); }
.section-num { background:var(--uc); color:white; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.72rem; font-weight:600; flex-shrink:0; }
.section-header h3 { font-family:'Playfair Display',serif; font-size:1rem; color:var(--uc); }
.section-credits { margin-left:auto; font-size:0.73rem; color:var(--muted); }
.optional-note { font-size:0.75rem; color:var(--muted); font-style:italic; margin-bottom:8px; padding-left:4px; }
.info-pill { display:inline-block; background:#e8eef8; color:var(--uc); font-size:0.72rem; padding:4px 12px; border-radius:20px; margin-bottom:10px; }

.course-row {
  display:grid; grid-template-columns:1fr 100px 90px 80px;
  gap:10px; align-items:center; padding:10px 14px;
  background:var(--row-bg); border-radius:10px; margin-bottom:6px;
  border:1.5px solid transparent; transition:border-color 0.15s, background 0.3s;
}
.course-row:hover { border-color:#d4cfc8; }
.course-row.graded   { background:var(--green-bg);  border-color:#b8dfc9; }
.course-row.failed   { background:var(--red-bg);    border-color:#f0c4be; }
.course-row.retrying { background:var(--orange-bg); border-color:#f5c8a0; }
.course-code { font-size:0.66rem; color:var(--muted); font-weight:500; text-transform:uppercase; }
.course-name { font-size:0.87rem; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.course-crd  { font-size:0.7rem; color:var(--muted); margin-top:1px; }
.grade-input { width:100%; border:1.5px solid #ddd; border-radius:8px; padding:7px 10px; font-family:'Outfit',sans-serif; font-size:0.9rem; font-weight:500; text-align:center; background:var(--input-bg); color:var(--text); transition:border-color 0.15s; }
.grade-input:focus { outline:none; border-color:var(--uc); }
.grade-input.valid   { border-color:var(--green); color:var(--green); }
.grade-input.invalid { border-color:var(--red);   color:var(--red);   }
.repite-toggle { display:flex; align-items:center; gap:5px; cursor:pointer; font-size:0.72rem; color:var(--muted); user-select:none; }
.repite-toggle input { accent-color:var(--orange); cursor:pointer; }
.course-status { font-size:0.72rem; color:var(--muted); text-align:center; }
.course-row.graded   .course-status { color:var(--green);  font-weight:600; }
.course-row.failed   .course-status { color:var(--red);    font-weight:600; }
.course-row.retrying .course-status { color:var(--orange); font-weight:600; }

/* FINAL SECTION */
.final-section { background:var(--final-bg); border-radius:16px; padding:28px; border:2px solid var(--border-col); margin-top:8px; }
.final-section h3 { font-family:'Playfair Display',serif; font-size:1.05rem; color:var(--uc); margin-bottom:20px; }
.elective-block { margin-bottom:24px; }
.elective-block h4 { font-size:0.8rem; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px; }
.elective-row { display:grid; grid-template-columns:1fr 90px 30px; gap:8px; align-items:center; margin-bottom:6px; }
.elective-row.four-col { grid-template-columns:1fr 70px 90px 30px; }
.el-input  { border:1.5px solid var(--border-col); border-radius:8px; padding:7px 10px; font-family:'Outfit',sans-serif; font-size:0.82rem; width:100%; background:var(--el-input-bg); color:var(--text); }
.el-input:focus { outline:none; border-color:var(--uc); }
.el-select { border:1.5px solid var(--border-col); border-radius:8px; padding:7px 10px; font-family:'Outfit',sans-serif; font-size:0.82rem; width:100%; background:var(--select-bg); color:var(--text); }
.add-btn { background:none; border:1.5px dashed #bbb; color:#999; padding:7px 16px; border-radius:8px; cursor:pointer; font-family:'Outfit',sans-serif; font-size:0.82rem; margin-top:6px; transition:all 0.2s; }
.add-btn:hover { border-color:var(--uc); color:var(--uc); }
.del-btn { background:none; border:none; color:#ccc; font-size:1.3rem; cursor:pointer; }
.del-btn:hover { color:var(--red); }
.exam-box { background:var(--final-bg); border:2px solid var(--gold); border-radius:12px; padding:18px 20px; display:flex; align-items:center; gap:20px; margin-bottom:20px; }
.exam-info h4 { font-family:'Playfair Display',serif; font-size:1rem; }
.exam-info p  { font-size:0.76rem; color:var(--muted); margin-top:3px; }
.exam-input { width:110px; border:2px solid var(--gold); border-radius:10px; padding:10px; font-family:'Playfair Display',serif; font-size:1.3rem; font-weight:600; text-align:center; color:var(--gold); background:var(--el-input-bg); flex-shrink:0; }
.exam-input:focus { outline:none; }
.final-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.final-box { background:var(--uc); border-radius:12px; padding:18px 20px; color:white; }
.final-box .fl { font-size:0.68rem; opacity:0.6; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px; }
.final-box .fn { font-family:'Playfair Display',serif; font-size:2rem; font-weight:700; }
.final-box .formula { font-size:0.68rem; opacity:0.45; margin-top:6px; }
.reset-row { display:flex; justify-content:center; margin-top:28px; }
.reset-btn-main { background:none; border:1.5px solid #ccc; color:var(--muted); padding:8px 20px; border-radius:20px; cursor:pointer; font-family:'Outfit',sans-serif; font-size:0.8rem; transition:all 0.2s; }
.reset-btn-main:hover { border-color:var(--red); color:var(--red); }
.no-grade-row { display:flex; align-items:center; gap:10px; padding:8px 14px; background:var(--no-grade-bg); border-radius:10px; margin-bottom:6px; font-size:0.82rem; color:var(--no-grade-color); }

@media(max-width:640px){
  .stats-bar { gap:14px; padding:12px 16px; }
  .calc-content { padding:20px 12px 60px; }
  .course-row { grid-template-columns:1fr 80px; }
  .course-row .repite-toggle, .course-row .course-status { display:none; }
  .final-grid { grid-template-columns:1fr; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 1 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-career">
  <div class="career-logo">
    <h1>Calculadora PPA</h1>
    <div class="gold-line"></div>
    <p>Facultad de Ciencias Biol√≥gicas ¬∑ Consejer√≠a Acad√©mica</p>
  </div>
  <div class="career-grid">
    <div class="career-card" onclick="selectCareer('bio')">
      <div class="career-icon">üß¨</div>
      <h3>Biolog√≠a</h3>
      <p>Malla antigua (hasta admisi√≥n 2021)</p>
    </div>
    <div class="career-card disabled">
      <div class="career-icon">üß¨</div>
      <h3>Biolog√≠a</h3>
      <p>Malla nueva (admisi√≥n 2022+)</p>
      <span class="badge-soon">Pr√≥ximamente</span>
    </div>
    <div class="career-card disabled">
      <div class="career-icon">üåä</div>
      <h3>Biolog√≠a Marina</h3>
      <p>Malla antigua y nueva</p>
      <span class="badge-soon">Pr√≥ximamente</span>
    </div>
    <div class="career-card disabled">
      <div class="career-icon">‚öóÔ∏è</div>
      <h3>Bioqu√≠mica</h3>
      <p>Malla completa</p>
      <span class="badge-soon">Pr√≥ximamente</span>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 2 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-calc">
  <div class="calc-header">
    <button class="back-btn" onclick="goBack()">‚Üê</button>
    <div class="calc-header-info">
      <h2>Biolog√≠a ‚Äî Malla Antigua</h2>
      <p>Ingresa tus notas ¬∑ los ramos reprobados tambi√©n cuentan en el PPA ¬∑ marca "Repite" si lo est√°s cursando de nuevo</p>
    </div>
  </div>

  <div class="stats-bar">
    <div class="ppa-main">
      <div class="big" id="stat-ppa">‚Äî</div>
      <div class="lbl">PPA Actual</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <span class="val" id="stat-crd">0</span>
      <span class="lbl">Cr√©ditos totales</span>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <span class="val" id="stat-apr">0</span>
      <span class="lbl">Aprobados</span>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <span class="val red" id="stat-rep">0</span>
      <span class="lbl">Reprobados</span>
    </div>
  </div>

  <div class="calc-content" id="calc-content"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MALLA BIOLOG√çA ANTIGUA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MALLA = [
  { year:'Primer A√±o', sems:[
    { num:1, label:'1er Semestre', cursos:[
      { code:'BIO101A', name:'T√≥picos de Biolog√≠a',        crd:5  },
      { code:'BIO141C', name:'Biolog√≠a de la C√©lula',       crd:10 },
      { code:'QIM101L', name:'Lab. Qu√≠mica General',        crd:10 },
      { code:'QIM100I', name:'Qu√≠mica General I',           crd:10 },
      { code:'MAT1000', name:'Pre-C√°lculo',                 crd:10 },
      { code:'FIL2001', name:'Filosof√≠a: ¬øPara qu√©?',       crd:10 },
      { code:'VRA2000', name:'Test de Ingl√©s (VRA2000)',     crd:0, noGrade:true },
    ]},
    { num:2, label:'2do Semestre', cursos:[
      { code:'BIO110C', name:'Biolog√≠a de Organismos y Comunidades', crd:10 },
      { code:'FIS109C', name:'F√≠sica para Ciencias',                  crd:10 },
      { code:'FIS0109', name:'Lab. F√≠sica para Ciencias',             crd:5  },
      { code:'QIM100B', name:'Qu√≠mica General II',                    crd:10 },
      { code:'MAT1100', name:'C√°lculo I',                             crd:10 },
    ]},
  ]},
  { year:'Segundo A√±o', sems:[
    { num:3, label:'3er Semestre', cursos:[
      { code:'BIO152C',  name:'Bases F√≠sicas de los Procesos Biol√≥gicos', crd:10 },
      { code:'BIO242C',  name:'Bioestad√≠stica',                            crd:10 },
      { code:'QIM200',   name:'Qu√≠mica Org√°nica Fundamental',              crd:10 },
    ]},
    { num:4, label:'4to Semestre', cursos:[
      { code:'BIO151E',  name:'Biolog√≠a de los Microorganismos', crd:10 },
      { code:'QIM150',   name:'Qu√≠mica-F√≠sica',                   crd:10 },
    ]},
  ]},
  { year:'Tercer A√±o', sems:[
    { num:5, label:'5to Semestre',
      optionalNote:'Elige UNA opci√≥n: BIO225C (Fisiolog√≠a y Bioqu√≠mica Vegetal) o BIO274E (Biolog√≠a y Fisiolog√≠a Celular)',
      cursos:[
        { code:'BIO226E', name:'Gen√©tica y Evoluci√≥n',               crd:10 },
        { code:'BIO228C', name:'Bioqu√≠mica y Gen√©tica Molecular',    crd:10 },
        { code:'BIO297C', name:'Lab. Bioqu√≠mica y Biolog√≠a Celular', crd:10 },
        { code:'BIO225C', name:'Fisiolog√≠a y Bioqu√≠mica Vegetal',    crd:10, optional:true },
        { code:'BIO274E', name:'Biolog√≠a y Fisiolog√≠a Celular',      crd:10, optional:true },
    ]},
    { num:6, label:'6to Semestre', cursos:[
      { code:'BIO231C', name:'Ecolog√≠a',                          crd:10 },
      { code:'BIO298E', name:'Trabajo Experimental en Ecolog√≠a',  crd:5  },
      { code:'BIO219E', name:'Biolog√≠a y Diversidad Vegetal',     crd:10 },
      { code:'BIO227E', name:'Biolog√≠a y Diversidad Animal',      crd:10 },
      { code:'BIO299E', name:'Fisiolog√≠a',                        crd:10 },
      { code:'BIO299L', name:'Laboratorio de Fisiolog√≠a',         crd:5  },
    ]},
  ]},
  { year:'Cuarto A√±o ‚Äî Licenciatura', sems:[
    { num:7, label:'7mo Semestre',
      note:'OPR Experiencia de Investigaci√≥n (BIO295A, 15 crd) + OPR adicionales opcionales',
      cursos:[
        { code:'BIO295A', name:'OPR Experiencia de Investigaci√≥n', crd:15 },
    ]},
    { num:8, label:'8vo Semestre',
      note:'Actividad de finalizaci√≥n (30 crd): Seminario de Investigaci√≥n, equivalencia por 3 OPR, o Pr√°ctica Profesional',
      cursos:[
        { code:'BIO296C', name:'Seminario de Investigaci√≥n / equivalencia / Pr√°ctica', crd:30 },
    ]},
  ]},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentCareer = null;
let grades   = {};  // code -> {nota, repite}
let examGrado = null;
let efgExtra  = []; // {id,area,nota}
let oprLic    = []; // {id,nombre,crd,nota}
let uid = 0;

const EFG_AREAS = ['Teol√≥gico','Humanidades','Artes','Salud y Bienestar','Cs. Sociales','Ecolog√≠a y Sustentabilidad','Libre'];

function selectCareer(id) {
  currentCareer = id;
  grades    = JSON.parse(localStorage.getItem('ppa4-g-'+id) || '{}');
  examGrado = grades.__exam__ !== undefined ? grades.__exam__ : null;
  efgExtra  = JSON.parse(localStorage.getItem('ppa4-efg-'+id) || '[]');
  oprLic    = JSON.parse(localStorage.getItem('ppa4-opr-'+id) || '[]');
  uid = efgExtra.length + oprLic.length;
  document.getElementById('screen-career').style.display = 'none';
  document.getElementById('screen-calc').style.display   = 'block';
  renderCalc();
}

function goBack() {
  document.getElementById('screen-career').style.display = 'flex';
  document.getElementById('screen-calc').style.display   = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCalc() {
  const c = document.getElementById('calc-content');
  c.innerHTML = '';

  MALLA.forEach(yr => {
    const yl = document.createElement('div');
    yl.className = 'year-label';
    yl.textContent = yr.year;
    c.appendChild(yl);

    yr.sems.forEach(sem => {
      const sec = document.createElement('div');
      sec.className = 'section';
      const crdTotal = sem.cursos.filter(x=>!x.noGrade).reduce((a,x)=>a+x.crd,0);
      sec.innerHTML = `<div class="section-header"><div class="section-num">${sem.num}</div><h3>${sem.label}</h3><span class="section-credits">${crdTotal} cr√©ditos</span></div>`;
      if (sem.optionalNote) { const d=document.createElement('div'); d.className='optional-note'; d.textContent='* '+sem.optionalNote; sec.appendChild(d); }
      if (sem.note)         { const d=document.createElement('div'); d.className='info-pill'; d.textContent='üìå '+sem.note; sec.appendChild(d); }
      sem.cursos.forEach(curso => sec.appendChild(makeCourseRow(curso)));
      c.appendChild(sec);
    });
  });

  c.appendChild(buildFinalSection());
  const rr = document.createElement('div');
  rr.className='reset-row';
  rr.innerHTML='<button class="reset-btn-main" onclick="resetAll()">üóë Reiniciar todo</button>';
  c.appendChild(rr);
  recalc();
}

function makeCourseRow(curso) {
  if (curso.noGrade) {
    const d = document.createElement('div');
    d.className = 'no-grade-row';
    d.innerHTML = `üìã <strong>${curso.code}</strong> ‚Äî ${curso.name} &nbsp;<em style="color:#aaa;">(sin nota ¬∑ requisito administrativo)</em>`;
    return d;
  }

  const g = grades[curso.code] || {};
  const nota   = g.nota !== undefined ? g.nota : '';
  const repite = !!g.repite;
  const n = parseFloat(nota);
  const hasN   = nota!=='' && !isNaN(n) && n>=1 && n<=7;
  const aprobado = hasN && n >= 4.0;

  let rowClass = 'course-row';
  if (repite)        rowClass += ' retrying';
  else if (hasN)     rowClass += aprobado ? ' graded' : ' failed';

  let statusText = repite ? 'üîÑ Repitiendo' : (hasN ? (aprobado ? '‚úì Aprobado' : '‚úó Reprobado') : '‚Äî');
  const optTag = curso.optional ? ' <span style="color:var(--gold);font-size:0.65rem;font-weight:700;">OPT</span>' : '';

  const div = document.createElement('div');
  div.className = rowClass;
  div.id = 'row-' + curso.code;
  div.innerHTML = `
    <div class="course-info">
      <div class="course-code">${curso.code}${optTag}</div>
      <div class="course-name" title="${curso.name}">${curso.name}</div>
      <div class="course-crd">${curso.crd} cr√©ditos${curso.isEFG?' ¬∑ EFG':''}</div>
    </div>
    <input class="grade-input ${hasN?(aprobado?'valid':'invalid'):''}" type="number"
      min="1" max="7" step="0.1" placeholder="Nota" value="${nota}"
      oninput="setGrade('${curso.code}',this.value,this)" />
    <label class="repite-toggle" title="Marca si reprobaste y est√°s dando el ramo de nuevo">
      <input type="checkbox" ${repite?'checked':''} onchange="setRepite('${curso.code}',this.checked)" /> Repite
    </label>
    <div class="course-status" id="status-${curso.code}">${statusText}</div>
  `;
  return div;
}

function buildFinalSection() {
  const box = document.createElement('div');
  box.className = 'final-section';
  box.id = 'final-section';

  box.innerHTML = `<h3>üìä Electivos, Examen de Grado y Notas Finales</h3>`;

  // EFG extra
  const efgB = document.createElement('div');
  efgB.className = 'elective-block';
  efgB.innerHTML = '<h4>EFG ‚Äî Optativos de Formaci√≥n General (60 cr√©ditos requeridos) ¬∑ ingresa nombre, √°rea, cr√©ditos y nota</h4>';
  efgB.id = 'efg-block';
  efgExtra.forEach(r => efgB.appendChild(makeEFGRow(r)));
  const addEFG = document.createElement('button');
  addEFG.className = 'add-btn'; addEFG.textContent = '+ Agregar EFG';
  addEFG.onclick = () => {
    const r = {id:'e'+(++uid), nombre:'', area:'', crd:10, nota:''};
    efgExtra.push(r); saveEFG();
    document.getElementById('efg-block').insertBefore(makeEFGRow(r), addEFG);
    recalc();
  };
  efgB.appendChild(addEFG);
  box.appendChild(efgB);

  // OPR Lic
  const oprB = document.createElement('div');
  oprB.className = 'elective-block';
  oprB.innerHTML = '<h4>OPR Licenciatura (20 crd requeridos) y OPR adicionales del 7mo semestre</h4>';
  oprB.id = 'opr-block';
  oprLic.forEach(r => oprB.appendChild(makeOPRRow(r)));
  const addOPR = document.createElement('button');
  addOPR.className = 'add-btn'; addOPR.textContent = '+ Agregar OPR';
  addOPR.onclick = () => {
    const r = {id:'o'+(++uid), nombre:'', crd:10, nota:''};
    oprLic.push(r); saveOPR();
    document.getElementById('opr-block').insertBefore(makeOPRRow(r), addOPR);
    recalc();
  };
  oprB.appendChild(addOPR);
  box.appendChild(oprB);

  // Examen de grado
  const examDiv = document.createElement('div');
  examDiv.className = 'exam-box';
  examDiv.innerHTML = `
    <div class="exam-info">
      <h4>Examen de Grado</h4>
      <p>Ponderaci√≥n: 25% de la Nota de Licenciatura</p>
      <p style="font-size:0.72rem;color:#bbb;margin-top:3px;">Nota Lic. = (0.75 √ó PPA) + (0.25 √ó Ex. Grado)</p>
    </div>
    <input class="exam-input" type="number" min="1" max="7" step="0.1"
      placeholder="‚Äî" value="${examGrado!==null?examGrado:''}"
      oninput="setExamen(this.value)" />
  `;
  box.appendChild(examDiv);

  // Grid notas finales
  const grid = document.createElement('div');
  grid.className = 'final-grid'; grid.id = 'final-grid';
  box.appendChild(grid);

  return box;
}

function makeEFGRow(r) {
  const div = document.createElement('div');
  div.style.cssText='display:grid;grid-template-columns:1fr 130px 60px 90px 30px;gap:8px;align-items:center;margin-bottom:6px;';
  div.id='efg-'+r.id;

  const ni=document.createElement('input'); ni.className='el-input'; ni.type='text'; ni.placeholder='Nombre del curso'; ni.value=r.nombre||'';
  ni.oninput=e=>{r.nombre=e.target.value;saveEFG();};

  const sel = document.createElement('select'); sel.className='el-select';
  sel.innerHTML = '<option value="">‚Äî √Årea ‚Äî</option>' + EFG_AREAS.map(a=>`<option ${r.area===a?'selected':''} value="${a}">${a}</option>`).join('');
  sel.onchange = e => { r.area=e.target.value; saveEFG(); };

  const ci=document.createElement('input'); ci.className='el-input'; ci.type='number'; ci.min=1; ci.placeholder='Crd'; ci.value=r.crd||10; ci.style.textAlign='center';
  ci.oninput=e=>{r.crd=parseInt(e.target.value)||0;saveEFG();recalc();};

  const inp = document.createElement('input'); inp.className='el-input'; inp.type='number'; inp.min=1; inp.max=7; inp.step=0.1;
  inp.placeholder='Nota'; inp.value=r.nota||''; inp.style.textAlign='center'; inp.style.fontWeight='500';
  inp.oninput = e => { r.nota=e.target.value; saveEFG(); recalc(); };

  const del = document.createElement('button'); del.className='del-btn'; del.textContent='√ó';
  del.onclick = () => { efgExtra=efgExtra.filter(x=>x.id!==r.id); saveEFG(); div.remove(); recalc(); };

  div.appendChild(ni); div.appendChild(sel); div.appendChild(ci); div.appendChild(inp); div.appendChild(del);
  return div;
}

function makeOPRRow(r) {
  const div = document.createElement('div');
  div.className='elective-row four-col'; div.id='opr-'+r.id;
  const ni=document.createElement('input'); ni.className='el-input'; ni.type='text'; ni.placeholder='Nombre del OPR'; ni.value=r.nombre||'';
  ni.oninput=e=>{r.nombre=e.target.value;saveOPR();};
  const ci=document.createElement('input'); ci.className='el-input'; ci.type='number'; ci.min=1; ci.placeholder='Crd'; ci.value=r.crd||10; ci.style.textAlign='center';
  ci.oninput=e=>{r.crd=parseInt(e.target.value)||0;saveOPR();recalc();};
  const gi=document.createElement('input'); gi.className='el-input'; gi.type='number'; gi.min=1; gi.max=7; gi.step=0.1; gi.placeholder='Nota'; gi.value=r.nota||''; gi.style.textAlign='center'; gi.style.fontWeight='500';
  gi.oninput=e=>{r.nota=e.target.value;saveOPR();recalc();};
  const del=document.createElement('button'); del.className='del-btn'; del.textContent='√ó';
  del.onclick=()=>{oprLic=oprLic.filter(x=>x.id!==r.id);saveOPR();div.remove();recalc();};
  div.appendChild(ni);div.appendChild(ci);div.appendChild(gi);div.appendChild(del);
  return div;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setGrade(code, val, input) {
  if (!grades[code]) grades[code]={};
  grades[code].nota = val; saveGrades();
  const n=parseFloat(val), row=document.getElementById('row-'+code), st=document.getElementById('status-'+code);
  if(!row||!st) return;
  const repite=grades[code].repite;
  input.classList.remove('valid','invalid');
  row.classList.remove('graded','failed');
  if(repite) row.classList.add('retrying');
  if(val===''||isNaN(n)){ st.textContent=repite?'üîÑ Repitiendo':'‚Äî'; }
  else if(n>=1&&n<=7){
    const ok=n>=4;
    input.classList.add(ok?'valid':'invalid');
    if(!repite) row.classList.add(ok?'graded':'failed');
    st.textContent=repite?'üîÑ Repitiendo':(ok?'‚úì Aprobado':'‚úó Reprobado');
  }
  recalc();
}

function setRepite(code, checked) {
  if(!grades[code]) grades[code]={};
  grades[code].repite=checked; saveGrades();
  const row=document.getElementById('row-'+code), st=document.getElementById('status-'+code);
  if(!row||!st) return;
  row.classList.remove('graded','failed','retrying');
  const n=parseFloat(grades[code].nota), hasN=!isNaN(n)&&n>=1&&n<=7;
  if(checked){ row.classList.add('retrying'); st.textContent='üîÑ Repitiendo'; }
  else { if(hasN){row.classList.add(n>=4?'graded':'failed'); st.textContent=n>=4?'‚úì Aprobado':'‚úó Reprobado';} else st.textContent='‚Äî'; }
  recalc();
}

function setExamen(val) {
  examGrado = val===''?null:parseFloat(val);
  grades.__exam__=examGrado; saveGrades(); recalc();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// C√ÅLCULO PPA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function recalc() {
  let sumP=0, sumC=0, apr=0, rep=0;

  MALLA.forEach(yr=>yr.sems.forEach(sem=>sem.cursos.forEach(c=>{
    if(c.noGrade) return;
    const g=grades[c.code]||{}, n=parseFloat(g.nota);
    if(isNaN(n)||n<1||n>7) return;
    sumP+=n*c.crd; sumC+=c.crd;
    n>=4?apr++:rep++;
  })));

  efgExtra.forEach(r=>{
    const n=parseFloat(r.nota), crd=parseInt(r.crd)||0;
    if(isNaN(n)||n<1||n>7||crd<=0) return;
    sumP+=n*crd; sumC+=crd; n>=4?apr++:rep++;
  });

  oprLic.forEach(r=>{
    const n=parseFloat(r.nota), crd=parseInt(r.crd)||0;
    if(isNaN(n)||n<1||n>7||crd<=0) return;
    sumP+=n*crd; sumC+=crd; n>=4?apr++:rep++;
  });

  const ppa = sumC>0 ? sumP/sumC : null;
  const examN = examGrado!==null&&!isNaN(examGrado)&&examGrado>=1&&examGrado<=7 ? examGrado : null;
  const notaLic = ppa!==null&&examN!==null ? (0.75*ppa)+(0.25*examN) : null;

  // Stats bar
  const pe=document.getElementById('stat-ppa');
  if(ppa!==null){ pe.textContent=ppa.toFixed(2); pe.className='big '+(ppa>=5.5?'good':ppa>=4.5?'warn':'bad'); }
  else{ pe.textContent='‚Äî'; pe.className='big'; }
  document.getElementById('stat-crd').textContent=sumC;
  document.getElementById('stat-apr').textContent=apr;
  document.getElementById('stat-rep').textContent=rep;

  // Final grid
  const grid=document.getElementById('final-grid');
  if(grid) grid.innerHTML=`
    <div class="final-box">
      <div class="fl">PPA Licenciatura</div>
      <div class="fn">${ppa!==null?ppa.toFixed(2):'‚Äî'}</div>
      <div class="formula">${sumC} cr√©ditos ¬∑ ${apr+rep} ramos con nota</div>
    </div>
    <div class="final-box">
      <div class="fl">Nota de Licenciatura</div>
      <div class="fn">${notaLic!==null?notaLic.toFixed(2):(ppa!==null?'Falta examen':'‚Äî')}</div>
      <div class="formula">0.75 √ó PPA + 0.25 √ó Examen de Grado</div>
    </div>
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveGrades(){ localStorage.setItem('ppa4-g-'+currentCareer, JSON.stringify(grades)); }
function saveEFG()   { localStorage.setItem('ppa4-efg-'+currentCareer, JSON.stringify(efgExtra)); }
function saveOPR()   { localStorage.setItem('ppa4-opr-'+currentCareer, JSON.stringify(oprLic)); }

function resetAll(){
  if(!confirm('¬øEliminar todas las notas?')) return;
  grades={}; efgExtra=[]; oprLic=[]; examGrado=null;
  localStorage.removeItem('ppa4-g-'+currentCareer);
  localStorage.removeItem('ppa4-efg-'+currentCareer);
  localStorage.removeItem('ppa4-opr-'+currentCareer);
  renderCalc();
}
</script>
</body>
</html>
