<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora PPA â€” Ciencias BiolÃ³gicas</title>
<link rel="icon" type="image/png" href="https://i.ibb.co/JjN0BKLC/Whats-App-Image-2025-12-10-at-21-40-35.jpg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SISTEMA DE DISEÃ‘O SaaS 2025
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  /* Brand Gradients & Accents (Indigo/Violet) */
  --primary: #6366F1;
  --primary-hover: #4F46E5;
  --primary-gradient: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
  --gold: #F59E0B;
  
  /* Light Theme Colors */
  --bg: #F8F9FA;
  --surface: #FFFFFF;
  --text-main: #0F172A;
  --text-muted: #64748B;
  
  /* Status Colors (Soft Pastel Variants) */
  --success: #10B981;
  --success-bg: rgba(16, 185, 129, 0.1);
  --danger: #EF4444;
  --danger-bg: rgba(239, 68, 68, 0.1);
  --warning: #F59E0B;
  --warning-bg: rgba(245, 158, 11, 0.1);
  
  /* UI Elements */
  --row-bg: #F8FAFC;
  --input-bg: #F1F5F9;
  --border-subtle: #E2E8F0;
  
  /* Shadows & Glass */
  --shadow-sm: 0 4px 20px rgba(0, 0, 0, 0.03);
  --shadow-md: 0 12px 32px rgba(15, 23, 42, 0.06);
  --shadow-glow: 0 0 0 3px rgba(99, 102, 241, 0.2);
  --glass-bg: rgba(255, 255, 255, 0.75);
  --glass-border: rgba(255, 255, 255, 0.5);
  
  /* Animation Curves */
  --ease-spring: cubic-bezier(0.4, 0, 0.2, 1);
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0B0F19;
    --surface: #111827;
    --text-main: #F8FAFC;
    --text-muted: #94A3B8;
    
    --success: #34D399;
    --success-bg: rgba(52, 211, 153, 0.1);
    --danger: #F87171;
    --danger-bg: rgba(248, 113, 113, 0.1);
    --warning: #FBBF24;
    --warning-bg: rgba(251, 191, 36, 0.1);
    
    --row-bg: #1F2937;
    --input-bg: #0F172A;
    --border-subtle: #334155;
    
    --shadow-sm: 0 4px 20px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 12px 32px rgba(0, 0, 0, 0.5);
    --shadow-glow: 0 0 0 3px rgba(99, 102, 241, 0.3);
    --glass-bg: rgba(17, 24, 39, 0.75);
    --glass-border: rgba(255, 255, 255, 0.05);
  }
}

* { margin:0; padding:0; box-sizing:border-box; }
body { 
  font-family: 'Inter', system-ui, sans-serif; 
  background: var(--bg); 
  color: var(--text-main); 
  min-height: 100vh; 
  transition: background 0.4s ease, color 0.4s ease;
  -webkit-font-smoothing: antialiased;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CAREER SCREEN (Malla Selection)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-career {
  min-height: 100vh; display: flex; flex-direction: column;
  align-items: center; justify-content: center; padding: 40px 20px;
  background: var(--bg);
  background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                    radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.15) 0px, transparent 50%);
  position: relative; overflow: hidden;
}
.career-logo { 
  text-align: center; margin-bottom: 64px; position: relative; z-index: 1;
  animation: fadeDown 0.8s var(--ease-spring);
}
.main-logo { 
  width: 80px; height: 80px; margin-bottom: 24px; border-radius: 20px; 
  box-shadow: var(--shadow-md); background: var(--surface); padding: 4px; 
}
.career-logo h1 { font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; margin-bottom: 8px; color: var(--text-main); }
.career-logo p { color: var(--text-muted); font-size: 1rem; font-weight: 500; }

.career-grid { 
  display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
  gap: 24px; max-width: 900px; width: 100%; position: relative; z-index: 1;
  animation: fadeUp 0.8s var(--ease-spring) 0.1s backwards;
}
.career-card { 
  background: var(--glass-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
  border: 1px solid var(--glass-border); border-radius: 24px; 
  padding: 32px 24px; cursor: pointer; 
  transition: all 0.4s var(--ease-spring);
  display: flex; flex-direction: column; align-items: center; text-align: center;
  box-shadow: var(--shadow-sm);
}
.career-card:hover { 
  transform: translateY(-6px); box-shadow: var(--shadow-md); 
  border-color: rgba(99, 102, 241, 0.3);
}
.career-icon { font-size: 2.5rem; margin-bottom: 16px; transition: transform 0.4s var(--ease-spring); }
.career-card:hover .career-icon { transform: scale(1.1); }
.career-card h3 { color: var(--text-main); font-size: 1.05rem; font-weight: 600; line-height: 1.4; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALC SCREEN & STATS BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-calc { display: none; min-height: 100vh; padding-bottom: 80px; }

.stats-bar-wrapper {
  position: sticky; top: 0; z-index: 100;
  background: var(--glass-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
  border-bottom: 1px solid var(--border-subtle);
  box-shadow: var(--shadow-sm);
}

.stats-bar {
  padding: 16px 32px; display: flex; align-items: center; gap: 40px; flex-wrap: wrap;
  max-width: 1000px; margin: 0 auto;
}

.back-btn { 
  background: var(--input-bg); border: 1px solid var(--border-subtle); color: var(--text-muted); 
  width: 40px; height: 40px; border-radius: 12px; cursor: pointer; font-size: 1.2rem; 
  display: flex; align-items: center; justify-content: center; 
  transition: all 0.2s var(--ease-spring); margin-right: 8px;
}
.back-btn:hover { background: var(--surface); color: var(--text-main); transform: scale(1.05); }

.ppa-main .big { font-size: 2.5rem; font-weight: 800; color: var(--text-main); line-height: 1; letter-spacing: -1px; }
.ppa-main .lbl, .stat-item .lbl { 
  font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; 
  font-weight: 500; display: block;
}

.stat-divider { width: 1px; height: 32px; background: var(--border-subtle); }
.stat-item .val { font-size: 1.5rem; font-weight: 700; color: var(--text-main); line-height: 1; letter-spacing: -0.5px;}

/* Visual Progress Bar */
.progress-container {
  max-width: 1000px; margin: 0 auto; padding: 0 32px 16px;
}
.progress-track {
  width: 100%; height: 6px; background: var(--input-bg); border-radius: 6px; overflow: hidden;
}
.progress-fill {
  height: 100%; background: var(--primary-gradient); border-radius: 6px;
  width: 0%; transition: width 1s var(--ease-spring);
}
.progress-header { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); font-weight: 500; margin-bottom: 8px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTENT & CARDS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.calc-content { max-width: 900px; margin: 0 auto; padding: 40px 24px; }
.year-label { 
  font-size: 1.5rem; color: var(--text-main); margin: 48px 0 24px; font-weight: 800; 
  letter-spacing: -0.5px;
}

.section { 
  background: var(--surface); border-radius: 24px; padding: 24px; 
  margin-bottom: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-subtle);
  transition: transform 0.3s var(--ease-spring), box-shadow 0.3s var(--ease-spring);
}
.section:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }

.section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
.section-num { 
  background: var(--primary-gradient); color: white; width: 32px; height: 32px; 
  border-radius: 10px; display: flex; align-items: center; justify-content: center; 
  font-size: 0.85rem; font-weight: 700; 
}
.section-header h3 { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
.section-credits { margin-left: auto; font-size: 0.8rem; color: var(--text-muted); font-weight: 600; background: var(--row-bg); padding: 6px 12px; border-radius: 20px;}

.optional-note { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px; padding: 12px 16px; background: var(--input-bg); border-radius: 12px; border-left: 3px solid var(--primary); }

/* Course Rows */
.course-row {
  display: grid; grid-template-columns: 1fr 100px 110px 40px;
  gap: 16px; align-items: center; padding: 16px;
  background: var(--row-bg); border-radius: 16px; margin-bottom: 8px;
  border: 1px solid transparent; transition: all 0.2s var(--ease-spring);
}
.course-row:hover { border-color: var(--border-subtle); background: var(--surface); }

.course-code { font-size: 0.75rem; color: var(--text-muted); font-weight: 700; letter-spacing: 0.5px; margin-bottom: 4px;}
.course-name { font-size: 0.95rem; font-weight: 600; color: var(--text-main); }
.course-crd { font-size: 0.8rem; color: var(--text-muted); margin-top: 6px; font-weight: 500;}

/* Minimalist Badges */
.badge { display: inline-flex; align-items: center; justify-content: center; padding: 4px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
.badge-empty { background: var(--input-bg); color: var(--text-muted); }
.badge-success { background: var(--success-bg); color: var(--success); }
.badge-danger { background: var(--danger-bg); color: var(--danger); }

/* Inputs */
.grade-input { 
  width: 100%; border: 1px solid var(--border-subtle); border-radius: 12px; padding: 10px; 
  font-family: 'Inter', sans-serif; font-size: 1rem; font-weight: 600; text-align: center; 
  background: var(--surface); color: var(--text-main); transition: all 0.2s var(--ease-spring); 
}
.grade-input:focus { outline: none; border-color: var(--primary); box-shadow: var(--shadow-glow); }
.grade-input.valid { color: var(--success); border-color: rgba(16, 185, 129, 0.3); }
.grade-input.invalid { color: var(--danger); border-color: rgba(239, 68, 68, 0.3); }

/* Buttons & Microinteractions */
.btn-link { 
  background: none; border: none; color: var(--primary); cursor: pointer; padding: 0; 
  font-family: 'Inter', sans-serif; font-weight: 600; transition: opacity 0.2s;
}
.btn-link:hover { opacity: 0.7; }

.del-btn { 
  background: transparent; border: none; color: var(--text-muted); width: 36px; height: 36px; border-radius: 10px;
  font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; 
}
.del-btn:hover { background: var(--danger-bg); color: var(--danger); }

.add-btn { 
  background: transparent; border: 1px dashed var(--border-subtle); color: var(--text-muted); 
  padding: 14px 20px; border-radius: 16px; cursor: pointer; font-family: 'Inter', sans-serif; 
  font-size: 0.9rem; margin-top: 8px; transition: all 0.2s var(--ease-spring); font-weight: 600; width: 100%;
}
.add-btn:hover { border-color: var(--primary); color: var(--primary); background: rgba(99, 102, 241, 0.05); }

.retry-btn { 
  margin-top: 8px; padding: 12px; background: var(--warning-bg); color: var(--warning); 
  border: none; width: 100%; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: transform 0.2s var(--ease-spring);
}
.retry-btn:hover { transform: scale(0.99); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FINAL SECTION & SIMULATOR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.final-section { 
  background: var(--surface); border-radius: 24px; padding: 32px; 
  box-shadow: var(--shadow-sm); border: 1px solid var(--border-subtle); margin-top: 24px; 
}
.final-section h3 { font-size: 1.2rem; font-weight: 800; color: var(--text-main); margin-bottom: 24px; letter-spacing: -0.5px;}

.el-input, .el-select { 
  border: 1px solid var(--border-subtle); border-radius: 12px; padding: 10px 12px; 
  font-family: 'Inter', sans-serif; font-size: 0.9rem; width: 100%; 
  background: var(--surface); color: var(--text-main); transition: all 0.2s var(--ease-spring); 
}
.el-input:focus, .el-select:focus { outline: none; border-color: var(--primary); box-shadow: var(--shadow-glow); }

.elective-row { display: grid; grid-template-columns: 1fr 130px 70px 90px 40px; gap: 12px; align-items: center; margin-bottom: 12px; }
.elective-row.four-col { grid-template-columns: 1fr 80px 100px 40px; }

.exam-box { 
  background: var(--row-bg); border-radius: 20px; padding: 24px; 
  display: flex; align-items: center; justify-content: space-between; gap: 20px; margin: 32px 0; border: 1px solid var(--border-subtle);
}
.exam-info h4 { font-weight: 700; font-size: 1.1rem; margin-bottom: 4px; color: var(--text-main);}
.exam-input { 
  width: 120px; border: 1px solid var(--border-subtle); border-radius: 16px; padding: 16px; 
  font-family: 'Inter', sans-serif; font-size: 1.5rem; font-weight: 800; text-align: center; 
  color: var(--text-main); background: var(--surface); flex-shrink: 0; transition: all 0.2s;
}
.exam-input:focus { border-color: var(--primary); box-shadow: var(--shadow-glow); outline: none;}

.final-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.final-box { 
  background: var(--primary-gradient); border-radius: 20px; padding: 24px; color: white; 
  box-shadow: 0 12px 24px rgba(99, 102, 241, 0.2); position: relative; overflow: hidden;
}
.final-box::after { content:''; position:absolute; top:0; right:0; width:150px; height:150px; background:rgba(255,255,255,0.1); border-radius:50%; transform:translate(30%, -30%); }
.final-box .fl { font-size: 0.8rem; opacity: 0.9; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600; }
.final-box .fn { font-size: 2.5rem; font-weight: 800; line-height: 1;}
.final-box .formula { font-size: 0.8rem; opacity: 0.8; margin-top: 12px; font-weight: 500;}

/* Utilities */
.no-grade-row { display: flex; align-items: center; padding: 16px; background: var(--input-bg); border-radius: 16px; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-muted); }
.fifth-year-box { background: var(--input-bg); color: var(--text-muted); padding: 24px; text-align: center; border-radius: 20px; margin: 32px 0 16px; font-weight: 600; border: 1px dashed var(--border-subtle); }
.reset-row { display: flex; justify-content: center; margin-top: 40px; }
.reset-btn-main { background: none; border: 1px solid var(--border-subtle); color: var(--danger); padding: 12px 24px; border-radius: 100px; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.9rem; transition: all 0.2s var(--ease-spring); font-weight: 600; }
.reset-btn-main:hover { background: var(--danger-bg); border-color: transparent; }

/* Modal Simulator */
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 9999; align-items: center; justify-content: center; opacity: 0; animation: fadeIn 0.3s forwards; }
.modal-box { background: var(--surface); width: 95%; max-width: 500px; padding: 32px; border-radius: 24px; box-shadow: var(--shadow-md); border: 1px solid var(--border-subtle); max-height: 90vh; overflow-y: auto; transform: translateY(20px); animation: slideUp 0.3s forwards; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
.modal-header h3 { font-size: 1.2rem; font-weight: 800; }
.close-btn { background: var(--input-bg); border: none; font-size: 1.2rem; width: 36px; height: 36px; border-radius: 12px; cursor: pointer; color: var(--text-muted); display:flex; align-items:center; justify-content:center; transition: all 0.2s;}
.close-btn:hover { background: var(--border-subtle); color: var(--text-main); }

.sim-input { border: 1px solid var(--border-subtle); border-radius: 12px; padding: 12px; font-family: 'Inter', sans-serif; font-size: 0.9rem; text-align: center; background: var(--surface); color: var(--text-main); width: 100%; transition: all 0.2s;}
.sim-input:focus { outline:none; border-color:var(--primary); box-shadow: var(--shadow-glow); }
.sim-row { display: grid; grid-template-columns: 1fr 80px 80px 40px; gap: 12px; margin-bottom: 12px; align-items: center; }
.sim-save-btn { background: var(--text-main); color: var(--bg); border: none; padding: 16px; border-radius: 16px; cursor: pointer; font-size: 0.95rem; width: 100%; margin-top: 24px; font-weight: 600; transition: transform 0.2s var(--ease-spring); }
.sim-save-btn:hover { transform: scale(0.98); }

/* Toasts & Animations */
#toast-felicidades {
  visibility: hidden; min-width: 280px; background: var(--primary-gradient); color: white;
  text-align: center; border-radius: 100px; padding: 16px 24px; position: fixed;
  z-index: 10000; left: 50%; bottom: 20px; transform: translate(-50%, 20px);
  font-size: 1rem; font-weight: 600; box-shadow: var(--shadow-md);
  opacity: 0; transition: all 0.4s var(--ease-spring);
}
#toast-felicidades.show { visibility: visible; opacity: 1; transform: translate(-50%, 0); bottom: 40px; }

@keyframes fadeDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { to { opacity: 1; } }
@keyframes slideUp { to { transform: translateY(0); } }

@media(max-width: 768px){
  .course-row { grid-template-columns: 1fr 80px 80px 36px; padding: 16px; gap: 12px;}
  .elective-row { grid-template-columns: 1fr 100px 80px 36px; }
  .elective-row.four-col { grid-template-columns: 1fr 70px 80px 36px; }
  .final-grid { grid-template-columns: 1fr; }
  .stats-bar { padding: 16px 24px; gap: 16px; justify-content: space-between;}
  .stat-divider { display: none; }
  .ppa-main { width: 100%; margin-bottom: 8px;}
}
</style>
</head>
<body>

<div id="toast-felicidades">ğŸ‰ Â¡Felicidades, te eximiste!</div>

<div id="screen-career">
  <div class="career-logo">
    <img src="https://i.ibb.co/JjN0BKLC/Whats-App-Image-2025-12-10-at-21-40-35.jpg" alt="Logo CABIOUC" class="main-logo">
    <h1>Calculadora PPA</h1>
    <p>Facultad de Ciencias BiolÃ³gicas Â· ConsejerÃ­a AcadÃ©mica</p>
  </div>
  <div class="career-grid">
    <div class="career-card" onclick="selectCareer('bio')">
      <div class="career-icon">ğŸŒ³</div>
      <h3>BiologÃ­a Malla Antigua</h3>
    </div>
    <div class="career-card" onclick="selectCareer('bio_new')">
      <div class="career-icon">ğŸƒ</div>
      <h3>BiologÃ­a Malla Nueva</h3>
    </div>
    <div class="career-card" onclick="selectCareer('biomar')">
      <div class="career-icon">ğŸª¼</div>
      <h3>BiologÃ­a Marina Malla Antigua</h3>
    </div>
    <div class="career-card" onclick="selectCareer('biomar_new')">
      <div class="career-icon">ğŸ¡</div>
      <h3>BiologÃ­a Marina Malla Nueva</h3>
    </div>
    <div class="career-card" onclick="selectCareer('bq')">
      <div class="career-icon">ğŸ§¬</div>
      <h3>BioquÃ­mica</h3>
    </div>
  </div>
</div>

<div id="screen-calc">
  <div class="stats-bar-wrapper">
    <div class="stats-bar">
      <button class="back-btn" onclick="goBack()">â†</button>
      <div class="ppa-main">
        <div class="big" id="stat-ppa">â€”</div>
        <div class="lbl">PPA Actual</div>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-item">
        <span class="val" id="stat-crd">0</span>
        <span class="lbl">CrÃ©ditos</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-item">
        <span class="val" id="stat-apr">0</span>
        <span class="lbl">Aprobados</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-item">
        <span class="val" id="stat-rep" style="color:var(--danger)">0</span>
        <span class="lbl">Reprobados</span>
      </div>
    </div>
    
    <div class="progress-container">
      <div class="progress-header">
        <span>Avance Curricular (410 crd)</span>
        <span id="stat-prog-text">0%</span>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="stat-prog-fill"></div>
      </div>
    </div>
  </div>

  <div class="calc-content" id="calc-content"></div>
  
  <div style="text-align: center; margin-top: 40px; color: var(--text-muted); font-size: 0.85rem; font-weight: 500;">
    CABIOUC 2026
  </div>
</div>

<div id="sim-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="sim-title">Simulador de Notas</h3>
      <button class="close-btn" onclick="closeSim()">Ã—</button>
    </div>
    
    <div style="background:var(--row-bg); padding:20px; border-radius:16px; margin-bottom:24px; border:1px solid var(--border-subtle);">
      <label style="display:flex; align-items:center; gap:10px; font-weight:600; cursor:pointer;">
        <input type="checkbox" id="sim-chk-exam" onchange="toggleSimExam()" style="width:18px; height:18px; accent-color:var(--primary);"> 
        El curso tiene Examen Final
      </label>
      <div id="sim-exam-details" style="display:none; grid-template-columns: 1fr 1fr; gap:16px; margin-top:16px;">
        <div>
          <label style="font-size:0.8rem; color:var(--text-muted); font-weight:600; display:block; margin-bottom:6px;">PonderaciÃ³n Examen (%)</label>
          <input type="number" id="sim-inp-exam-weight" class="sim-input" value="30" oninput="updateSimConfig()">
        </div>
        <div>
          <label style="font-size:0.8rem; color:var(--text-muted); font-weight:600; display:block; margin-bottom:6px;">Nota eximiciÃ³n</label>
          <input type="number" id="sim-inp-exam-exim" class="sim-input" step="0.1" value="5.0" oninput="updateSimConfig()">
        </div>
      </div>
    </div>

    <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:16px; font-weight:600;">
      Evaluaciones de PresentaciÃ³n (Suman 100%)
    </p>
    
    <div id="sim-rows"></div>
    <button class="add-btn" onclick="addSimRow()">+ Agregar evaluaciÃ³n</button>

    <div id="sim-exam-grade-box" style="display:none; margin-top:20px; background:var(--warning-bg); padding:20px; border-radius:16px; border:1px dashed var(--warning);">
      <label style="font-size:0.9rem; color:var(--warning); font-weight:700; display:block; margin-bottom:12px;">Ingresa la nota del examen:</label>
      <input type="number" id="sim-inp-exam-grade" class="sim-input" style="border-color:var(--warning); max-width:150px; font-size:1.1rem; font-weight:bold;" min="1" max="7" step="0.1" placeholder="Nota" oninput="updateSimExamGrade()">
    </div>

    <div style="background:var(--row-bg); border:1px solid var(--border-subtle); border-radius:16px; padding:20px; margin-top:24px; font-size:0.9rem; line-height:1.6;" id="sim-results-content">
    </div>

    <button class="sim-save-btn" onclick="useSimGrade()">Guardar Nota en la Calculadora</button>
  </div>
</div>

<script>
// El bloque de Mallas se mantiene intacto. 
// Copio directo tu data para asegurar compatibilidad.
const MALLAS = {
  bio: [
    { year:'Primer AÃ±o', sems:[
      { num:1, label:'1er Semestre', cursos:[
        { code:'BIO101A', name:'TÃ³picos de BiologÃ­a',        crd:5  },
        { code:'BIO141C', name:'BiologÃ­a de la CÃ©lula',       crd:10 },
        { code:'QIM101L', name:'Lab. QuÃ­mica General',        crd:10 },
        { code:'QIM100I', name:'QuÃ­mica General I',           crd:10 },
        { code:'MAT1000', name:'Pre-CÃ¡lculo',                 crd:10 },
        { code:'FIL2001', name:'FilosofÃ­a: Â¿Para quÃ©?',       crd:10 }
      ]},
      { num:2, label:'2do Semestre', cursos:[
        { code:'BIO110C', name:'BiologÃ­a de Organismos y Comunidades', crd:10 },
        { code:'FIS109C', name:'FÃ­sica para Ciencias',                 crd:10 },
        { code:'QIM100B', name:'QuÃ­mica General II',                   crd:10 },
        { code:'MAT1100', name:'CÃ¡lculo I',                            crd:10 },
      ]},
    ]},
    { year:'Segundo AÃ±o', sems:[
      { num:3, label:'3er Semestre', cursos:[
        { code:'BIO152C',  name:'Bases FÃ­sicas de los Procesos BiolÃ³gicos', crd:10 },
        { code:'BIO242C',  name:'BioestadÃ­stica',                            crd:10 },
        { code:'QIM200',   name:'QuÃ­mica OrgÃ¡nica Fundamental',              crd:10 },
      ]},
      { num:4, label:'4to Semestre', cursos:[
        { code:'BIO151E',  name:'BiologÃ­a de los Microorganismos', crd:10 },
        { code:'QIM150',   name:'QuÃ­mica-FÃ­sica',                  crd:10 },
      ]},
    ]},
    { year:'Tercer AÃ±o', sems:[
      { num:5, label:'5to Semestre',
        optionalNote:'Elige UNA opciÃ³n: BIO225C (FisiologÃ­a y BioquÃ­mica Vegetal) o BIO274E (BiologÃ­a y FisiologÃ­a Celular)',
        cursos:[
          { code:'BIO226E', name:'GenÃ©tica y EvoluciÃ³n',               crd:10 },
          { code:'BIO228C', name:'BioquÃ­mica y GenÃ©tica Molecular',    crd:10 },
          { code:'BIO297C', name:'Lab. BioquÃ­mica y BiologÃ­a Celular', crd:10 },
          { code:'BIO225C', name:'FisiologÃ­a y BioquÃ­mica Vegetal',    crd:10, optional:true },
          { code:'BIO274E', name:'BiologÃ­a y FisiologÃ­a Celular',      crd:10, optional:true },
      ]},
      { num:6, label:'6to Semestre', cursos:[
        { code:'BIO231C', name:'EcologÃ­a',                          crd:10 },
        { code:'BIO298E', name:'Trabajo Experimental en EcologÃ­a',  crd:5  },
        { code:'BIO219E', name:'BiologÃ­a y Diversidad Vegetal',     crd:10 },
        { code:'BIO227E', name:'BiologÃ­a y Diversidad Animal',      crd:10 },
        { code:'BIO299E', name:'FisiologÃ­a',                        crd:10 },
        { code:'BIO299L', name:'Laboratorio de FisiologÃ­a',         crd:5  },
      ]},
    ]},
    { year:'Cuarto AÃ±o â€” Licenciatura', sems:[
      { num:7, label:'7mo Semestre',
        cursos:[
          { code:'BIO295A', name:'Seminario de investigaciÃ³n', crd:15 }
      ]},
      { num:8, label:'8vo Semestre',
        cursos:[
          { code:'BIO296C', name:'Seminario de InvestigaciÃ³n / cursos (agregar en lista OPR) / PrÃ¡ctica extramural', crd:30 },
      ]},
    ]},
  ],
  bq: [
    { year:'Primer AÃ±o', sems:[
      { num:1, label:'1er Semestre', cursos:[
        { code:'BIO101B', name:'TÃ³picos de BioquÃ­mica', crd:5 },
        { code:'QIM1001', name:'QuÃ­mica General I', crd:10 },
        { code:'MAT1000', name:'Pre-CÃ¡lculo', crd:10 },
        { code:'QIM101L', name:'Lab. QuÃ­mica General', crd:5 },
        { code:'BIO141C', name:'BiologÃ­a de la CÃ©lula', crd:10 },
        { code:'FIL2001', name:'FilosofÃ­a: Â¿Para quÃ©?', crd:10 }
      ]},
      { num:2, label:'2do Semestre', cursos:[
        { code:'QIM100B', name:'QuÃ­mica General II', crd:10 },
        { code:'MAT1100', name:'CÃ¡lculo', crd:10 },
        { code:'FIS109C', name:'FÃ­sica para Ciencias', crd:10 }
      ]}
    ]},
    { year:'Segundo AÃ±o', sems:[
      { num:3, label:'3er Semestre', cursos:[
        { code:'BIO152C', name:'Bases FÃ­sicas de los Procesos BiolÃ³gicos', crd:10 },
        { code:'BIO242C', name:'BioestadÃ­stica', crd:10 },
        { code:'QIM102B', name:'QuÃ­mica OrgÃ¡nica I', crd:10 },
        { code:'QIM109B', name:'QuÃ­mica AnalÃ­tica I', crd:10 }
      ]},
      { num:4, label:'4to Semestre', cursos:[
        { code:'QIM103A', name:'QuÃ­mica OrgÃ¡nica II', crd:10 },
        { code:'QIM111', name:'AnÃ¡lisis Instrumental', crd:10 },
        { code:'BIO151E', name:'BiologÃ­a de los Microorganismos', crd:10 }
      ]}
    ]},
    { year:'Tercer AÃ±o', sems:[
      { num:5, label:'5to Semestre',
        optionalNote:'Elige UNA opciÃ³n: BIO225C (FisiologÃ­a y BioquÃ­mica Vegetal) o BIO274C (BiologÃ­a y FisiologÃ­a Celular)', 
        cursos:[
        { code:'BIO257C', name:'BioquÃ­mica', crd:10 },
        { code:'BIO266D', name:'Laboratorio BioquÃ­mica I / BiologÃ­a Celular', crd:10 },
        { code:'BIO226E', name:'GenÃ©tica y EvoluciÃ³n', crd:10 },
        { code:'QIM104A', name:'Laboratorio QuÃ­mica OrgÃ¡nica', crd:10 },
        { code:'BIO225C', name:'FisiologÃ­a y BioquÃ­mica Vegetal', crd:10, optional:true },
        { code:'BIO274C', name:'BiologÃ­a y FisiologÃ­a Celular', crd:10, optional:true }
      ]},
      { num:6, label:'6to Semestre', cursos:[
        { code:'BIO266E', name:'Laboratorio BioquÃ­mica / GenÃ©tica Molecular', crd:10 },
        { code:'QIM114B', name:'QuÃ­mica FÃ­sica I', crd:10 },
        { code:'BIO288C', name:'GenÃ©tica Molecular', crd:10 },
        { code:'BIO299E', name:'FisiologÃ­a', crd:10 },
        { code:'BIO299L', name:'Laboratorio de FisiologÃ­a', crd:5 }
      ]}
    ]},
    { year:'Cuarto AÃ±o', sems:[
      { num:7, label:'7mo Semestre', cursos:[
        { code:'QIM115', name:'QuÃ­mica FÃ­sica II', crd:10 },
        { code:'BIO295A', name:'OPR Experiencia de InvestigaciÃ³n', crd:15 }
      ]},
      { num:8, label:'8vo Semestre', cursos:[
        { code:'BIO296F', name:'Seminario de InvestigaciÃ³n o BIO258E PrÃ¡ctica extramural', crd:30 },
        { code:'MEB176B', name:'Laboratorio ClÃ­nico', crd:10 }
      ]}
    ]}
  ],
  bio_new: [
    { year: 'Primer AÃ±o', sems: [
      { num: 1, label: '1er Semestre', cursos: [
        { code: 'BIO118C', name: 'EvoluciÃ³n', crd: 10 },
        { code: 'BIO114B', name: 'BiologÃ­a de la CÃ©lula', crd: 10 },
        { code: 'MAT1000', name: 'PrecÃ¡lculo', crd: 10 },
        { code: 'QIM1001', name: 'QuÃ­mica General', crd: 10 },
        { code: 'BIO105C', name: 'DesafÃ­os de las Ciencias BiolÃ³gicas', crd: 5 }
      ]},
      { num: 2, label: '2do Semestre', cursos: [
        { code: 'BIO120C', name: 'BiologÃ­a y Diversidad Vegetal', crd: 10 },
        { code: 'FIS109C', name: 'FÃ­sica para Ciencias', crd: 10 },
        { code: 'MAT1100', name: 'CÃ¡lculo I', crd: 10 },
        { code: 'QIM100B', name: 'QuÃ­mica General II', crd: 10 },
        { code: 'FIS0109', name: 'Laboratorio FÃ­sica para Ciencias', crd: 0, noGrade: true }
      ]}
    ]},
    { year: 'Segundo AÃ±o', sems: [
      { num: 3, label: '3er Semestre', cursos: [
        { code: 'BIO227E', name: 'BiologÃ­a y Diversidad Animal', crd: 10 },
        { code: 'BIO230C', name: 'BioestadÃ­stica', crd: 10 },
        { code: 'QIM200', name: 'QuÃ­mica OrgÃ¡nica Fundamental', crd: 10 },
        { code: 'BIO210C', name: 'TÃ³picos / Habilidades', crd: 5 },
        { code: 'BIO215C', name: 'MetodologÃ­a para la Inv. BiolÃ³gica', crd: 5 },
        { code: 'FIL2001', name: 'FilosofÃ­a Â¿Para quÃ©?', crd: 10 }
      ]},
      { num: 4, label: '4to Semestre', cursos: [
        { code: 'BIO247C', name: 'BiologÃ­a de Microorganismos', crd: 10 },
        { code: 'BIO235C', name: 'BiologÃ­a Computacional', crd: 10 },
        { code: 'BIO244C', name: 'BioquÃ­mica', crd: 10 }
      ]}
    ]},
    { year: 'Tercer AÃ±o', sems: [
      { num: 5, label: '5to Semestre', cursos: [
        { code: 'BIO330C', name: 'EcologÃ­a', crd: 10 },
        { code: 'BIO356C', name: 'GenÃ©tica Integrativa', crd: 10 },
        { code: 'BIO324C', name: 'BiologÃ­a del Desarrollo', crd: 10 },
        { code: 'BIO310C', name: 'BiomatemÃ¡tica / ModelaciÃ³n de Sist.', crd: 10 },
        { code: 'ETI201C', name: 'FilosofÃ­a y Ã‰tica de la Ciencia', crd: 5 }
      ]},
      { num: 6, label: '6to Semestre', cursos: [
        { code: 'BIO385C', name: 'FisiologÃ­a Celular', crd: 10 },
        { code: 'BIO372C', name: 'FisiologÃ­a Animal / Vegetal', crd: 10 },
        { code: 'BIO408C', name: 'EcoinformÃ¡tica / BioinformÃ¡tica', crd: 10 },
        { code: 'BIO390C', name: 'FisiologÃ­a de Sistemas', crd: 10 }
      ]}
    ]},
    { year: 'Cuarto AÃ±o', sems: [
      { num: 7, label: '7mo Semestre', cursos: [
        { code: 'BIO415C', name: 'Trabajo Experimental en BiologÃ­a', crd: 10 }
      ]},
      { num: 8, label: '8vo Semestre', cursos: [
        { code: 'BIO416C', name: 'Seminario de InvestigaciÃ³n I', crd: 25 }
      ]}
    ]}
  ],
  biomar: [
    { year:'Primer AÃ±o', sems:[
      { num:1, label:'1er Semestre', cursos:[
        { code:'BIO141C', name:'BiologÃ­a de la CÃ©lula', crd:10 },
        { code:'BIO116M', name:'BiologÃ­a Marina', crd:10 },
        { code:'MAT1000', name:'Pre-CÃ¡lculo', crd:10 },
        { code:'QIM100I', name:'QuÃ­mica General I', crd:10 },
        { code:'QIM101L', name:'Lab. QuÃ­mica General', crd:5 },
        { code:'FIL2001', name:'FilosofÃ­a: Â¿Para quÃ©?', crd:10 }
      ]},
      { num:2, label:'2do Semestre', cursos:[
        { code:'BIO110C', name:'BiologÃ­a de Organismos y Comunidades', crd:10 },
        { code:'FIS109C', name:'FÃ­sica para Ciencias', crd:10 },
        { code:'MAT1100', name:'CÃ¡lculo I', crd:10 },
        { code:'QIM100B', name:'QuÃ­mica General II', crd:10 },
        { code:'BIO150M', name:'Invertebrados Marinos', crd:10 }
      ]}
    ]},
    { year:'Segundo AÃ±o', sems:[
      { num:3, label:'3er Semestre', cursos:[
        { code:'BIO152C', name:'Bases FÃ­sicas de los Procesos BiolÃ³gicos', crd:10 },
        { code:'BIO242C', name:'BioestadÃ­stica', crd:10 },
        { code:'QIM200', name:'QuÃ­mica OrgÃ¡nica Fundamental', crd:10 }
      ]},
      { num:4, label:'4to Semestre', cursos:[
        { code:'BIO151E', name:'BiologÃ­a de los Microorganismos', crd:10 },
        { code:'QIM150', name:'QuÃ­mica-FÃ­sica', crd:10 },
        { code:'BIO120M', name:'BotÃ¡nica Marina', crd:10 }
      ]}
    ]},
    { year:'Tercer AÃ±o', sems:[
      { num:5, label:'5to Semestre', cursos:[
        { code:'BIO228C', name:'BioquÃ­mica y GenÃ©tica Molecular', crd:10 },
        { code:'BIO226E', name:'GenÃ©tica y EvoluciÃ³n', crd:10 },
        { code:'BIO297C', name:'Lab. BioquÃ­mica y BiologÃ­a Celular', crd:10 },
        { code:'BIO250M', name:'Vertebrados Marinos', crd:10 }
      ]},
      { num:6, label:'6to Semestre', cursos:[
        { code:'BIO231C', name:'EcologÃ­a', crd:10 },
        { code:'BIO299E', name:'FisiologÃ­a', crd:10 },
        { code:'BIO299L', name:'Laboratorio de FisiologÃ­a', crd:5 },
        { code:'BIO298E', name:'Trabajo Experimental en EcologÃ­a Marina', crd:5 },
        { code:'BIO237M', name:'OceanografÃ­a General', crd:10 }
      ]}
    ]},
    { year:'Cuarto AÃ±o', sems:[
      { num:7, label:'7mo Semestre', cursos:[
        { code:'BIO327M', name:'OceanografÃ­a FÃ­sico-BiolÃ³gica', crd:10 },
        { code:'BIO277M', name:'MicrobiologÃ­a Marina', crd:10 },
        { code:'BIO295A', name:'Seminario de InvestigaciÃ³n Departamental', crd:15 }
      ]},
      { num:8, label:'8vo Semestre',
        note: 'OpciÃ³n Licenciatura (Seminario de InvestigaciÃ³n O PrÃ¡ctica Extramural)',
        cursos:[
        { code:'BIO296M', name:'Seminario de Invest. / PrÃ¡ctica Extramural', crd:30 }
      ]}
    ]}
  ],
  biomar_new: [
    { year:'Primer AÃ±o', sems:[
      { num:1, label:'1er Semestre', cursos:[
        { code:'BIO118C', name:'EvoluciÃ³n', crd:10 },
        { code:'BIO114B', name:'BiologÃ­a de la CÃ©lula', crd:10 },
        { code:'MAT1000', name:'Pre-CÃ¡lculo', crd:10 },
        { code:'QIM1001', name:'QuÃ­mica General', crd:10 },
        { code:'BIO130M', name:'BiologÃ­a Marina', crd:10 }
      ]},
      { num:2, label:'2do Semestre', cursos:[
        { code:'BIO150M', name:'Invertebrados Marinos', crd:10 },
        { code:'FIS109C', name:'FÃ­sica para Ciencias', crd:10 },
        { code:'MAT1100', name:'CÃ¡lculo I', crd:10 },
        { code:'QIM100B', name:'QuÃ­mica General II', crd:10 }
      ]}
    ]},
    { year:'Segundo AÃ±o', sems:[
      { num:3, label:'3er Semestre', cursos:[
        { code:'BIO205M', name:'Vertebrados Marinos', crd:10 },
        { code:'BIO230C', name:'BioestadÃ­stica', crd:10 },
        { code:'BIO210C', name:'BiologÃ­a Computacional', crd:5 },
        { code:'BIO215C', name:'MetodologÃ­a para la Inv. BiolÃ³gica', crd:5 },
        { code:'QIM200', name:'QuÃ­mica OrgÃ¡nica Fundamental', crd:10 },
        { code:'FIL2001', name:'FilosofÃ­a Â¿Para quÃ©?', crd:10 }
      ]},
      { num:4, label:'4to Semestre', cursos:[
        { code:'BIO260M', name:'BotÃ¡nica Marina', crd:10 },
        { code:'BIO247C', name:'BioquÃ­mica', crd:10 },
        { code:'BIO356C', name:'GenÃ©tica Integrativa', crd:10 },
        { code:'BIO355M', name:'OceanografÃ­a General', crd:10 },
        { code:'TTF', name:'FormaciÃ³n TeolÃ³gica', crd:10 }
      ]}
    ]},
    { year:'Tercer AÃ±o', sems:[
      { num:5, label:'5to Semestre', cursos:[
        { code:'BIO342M', name:'MicrobiologÃ­a Marina', crd:10 },
        { code:'BIO330C', name:'EcologÃ­a (Major)', crd:10 },
        { code:'BIO324C', name:'FisiologÃ­a Celular (Major)', crd:10 },
        { code:'BIO310C', name:'BiomatemÃ¡tica / ModelaciÃ³n', crd:10 },
        { code:'ETI201C', name:'FilosofÃ­a y Ã‰tica de la Ciencia', crd:5 }
      ]},
      { num:6, label:'6to Semestre', cursos:[
        { code:'BIO374M', name:'Trabajo Experimental EcologÃ­a Marina', crd:10 },
        { code:'BIO372C', name:'FisiologÃ­a Animal Comparada', crd:10 },
        { code:'BIO408C', name:'EcoinformÃ¡tica (Major)', crd:10 }
      ]}
    ]},
    { year:'Cuarto AÃ±o', sems:[
      { num:7, label:'7mo Semestre', cursos:[
        { code:'BIO415M', name:'Seminario de InvestigaciÃ³n I', crd:10 }
      ]},
      { num:8, label:'8vo Semestre', cursos:[
        { code:'BIO416M', name:'Seminario de InvestigaciÃ³n II', crd:25 }
      ]}
    ]}
  ]
};

// STATE
let currentCareer = null;
let MALLA = [];
let ofgReq = 70;
let oprReq = 20;
let grades    = {}; 
let examGrado = null;
let efgExtra  = [];
let oprLic    = [];
let simData   = {};
let currentSimCourse = null;
let uid = 0;

const EFG_AREAS = ['TeolÃ³gico','Humanidades','Artes','Salud y Bienestar','Cs. Sociales','EcologÃ­a y Sustentabilidad','Libre'];

function selectCareer(id) {
  currentCareer = id;
  MALLA = MALLAS[id];
  
  if (id === 'bio') { ofgReq = 70; oprReq = 20; } 
  else if (id === 'bio_new') { ofgReq = 60; oprReq = 60; } 
  else if (id === 'biomar') { ofgReq = 60; oprReq = 50; } 
  else if (id === 'biomar_new') { ofgReq = 60; oprReq = 50; } 
  else if (id === 'bq') { ofgReq = 60; oprReq = 15; }

  grades    = JSON.parse(localStorage.getItem('ppa4-g-'+id) || '{}');
  examGrado = grades.__exam__ !== undefined ? grades.__exam__ : null;
  efgExtra  = JSON.parse(localStorage.getItem('ppa4-efg-'+id) || '[]');
  oprLic    = JSON.parse(localStorage.getItem('ppa4-opr-'+id) || '[]');
  simData   = JSON.parse(localStorage.getItem('ppa4-sim-'+id) || '{}');
  
  let maxUid = 0;
  efgExtra.forEach(r => { if(parseInt(r.id.substring(1)) > maxUid) maxUid = parseInt(r.id.substring(1)); });
  oprLic.forEach(r => { if(parseInt(r.id.substring(1)) > maxUid) maxUid = parseInt(r.id.substring(1)); });
  uid = maxUid;

  document.getElementById('screen-career').style.display = 'none';
  document.getElementById('screen-calc').style.display   = 'block';
  renderCalc();
}

function goBack() {
  document.getElementById('screen-career').style.display = 'flex';
  document.getElementById('screen-calc').style.display   = 'none';
}

function renderCalc() {
  const c = document.getElementById('calc-content');
  c.innerHTML = '';

  MALLA.forEach(yr => {
    const yl = document.createElement('div');
    yl.className = 'year-label';
    yl.innerHTML = yr.year;
    c.appendChild(yl);

    yr.sems.forEach(sem => {
      const sec = document.createElement('div');
      sec.className = 'section';
      const crdTotal = sem.cursos.filter(x=>!x.noGrade).reduce((a,x)=>a+x.crd,0);
      sec.innerHTML = `<div class="section-header"><div class="section-num">${sem.num}</div><h3>${sem.label}</h3><span class="section-credits">${crdTotal} crÃ©ditos</span></div>`;
      if (sem.optionalNote) { const d=document.createElement('div'); d.className='optional-note'; d.textContent='* '+sem.optionalNote; sec.appendChild(d); }
      if (sem.note)         { const d=document.createElement('div'); d.className='optional-note'; d.textContent='ğŸ“Œ '+sem.note; sec.appendChild(d); }
      sem.cursos.forEach(curso => sec.appendChild(makeCourseBlock(curso)));
      c.appendChild(sec);
    });
  });

  c.appendChild(buildFinalSection());

  const block5to = document.createElement('div');
  block5to.className = 'fifth-year-box';
  block5to.innerHTML = 'ğŸ“ 5to aÃ±o prÃ³ximamente...';
  c.appendChild(block5to);

  const rr = document.createElement('div');
  rr.className='reset-row';
  rr.innerHTML='<button class="reset-btn-main" onclick="resetAll()">Restablecer todo</button>';
  c.appendChild(rr);
  recalc();
}

function makeCourseBlock(curso) {
  if (curso.noGrade) {
    const d = document.createElement('div');
    d.className = 'no-grade-row';
    d.innerHTML = `ğŸ“‹ <strong style="color:var(--text-main); margin-right:6px;">${curso.code}</strong> ${curso.name} &nbsp;<em>(requisito)</em>`;
    return d;
  }

  const wrap = document.createElement('div');
  wrap.id = 'block-' + curso.code;

  if (!Array.isArray(grades[curso.code])) {
    const old = grades[curso.code];
    grades[curso.code] = (old && old.nota !== undefined && old.nota !== '') ? [old.nota] : [''];
  }

  const rebuildRows = () => {
    wrap.innerHTML = '';
    const atts = grades[curso.code];

    atts.forEach((nota, idx) => {
      const n = parseFloat(nota);
      const hasN = nota !== '' && !isNaN(n) && n >= 1 && n <= 7;
      const aprobado = hasN && n >= 4.0;
      const isRetry = idx > 0;

      let rowClass = 'course-row';
      let badgeClass = 'badge-empty';
      let badgeText = 'Pendiente';
      
      if (hasN) {
        rowClass += aprobado ? ' graded' : ' failed';
        badgeClass = aprobado ? 'badge-success' : 'badge-danger';
        badgeText = aprobado ? 'Aprobado' : 'Reprobado';
      }

      const intentoBadge = isRetry
        ? `<span style="display:inline-block;background:var(--warning-bg);color:var(--warning);font-size:0.6rem;font-weight:700;padding:2px 8px;border-radius:10px;margin-left:6px;">Intento ${idx+1}</span>`
        : '';

      const row = document.createElement('div');
      row.className = rowClass;
      row.id = 'row-' + curso.code + '-' + idx;
      
      row.innerHTML = `
        <div class="course-info">
          <div class="course-code">${curso.code} ${intentoBadge}</div>
          <div class="course-name" title="${curso.name}">${curso.name}</div>
          <div class="course-crd">
            ${curso.crd} crÃ©ditos Â· 
            <button class="btn-link" onclick="openSim('${curso.code}', '${curso.name.replace(/'/g, "\\'")}', 'malla', ${idx})">Simular notas</button>
          </div>
        </div>
        <input class="grade-input ${hasN?(aprobado?'valid':'invalid'):''}" type="number"
          min="1" max="7" step="0.1" placeholder="â€”" value="${nota}"
          oninput="setAttemptGrade('${curso.code}', ${idx}, this)" />
        <div class="course-status" id="status-wrap-${curso.code}-${idx}">
          <span class="badge ${badgeClass}" id="status-${curso.code}-${idx}">${badgeText}</span>
        </div>
        <div>
          ${isRetry ? `<button class="del-btn" onclick="removeAttempt('${curso.code}', ${idx})">Ã—</button>` : ''}
        </div>
      `;
      wrap.appendChild(row);
    });

    const lastNota = parseFloat(atts[atts.length - 1]);
    const approvedAlready = atts.some(n => parseFloat(n) >= 4.0);
    
    const retryBtn = document.createElement('button');
    retryBtn.className = 'retry-btn';
    retryBtn.id = 'retry-btn-' + curso.code;
    retryBtn.textContent = '+ Ramo Reprobado (AÃ±adir repeticiÃ³n)';
    retryBtn.style.display = (!isNaN(lastNota) && lastNota >= 1 && lastNota < 4 && !approvedAlready) ? 'block' : 'none';
    retryBtn.onclick = () => { addAttempt(curso.code); };
    wrap.appendChild(retryBtn);
  }

  rebuildRows();
  wrap._rebuild = rebuildRows;
  return wrap;
}

function buildFinalSection() {
  const box = document.createElement('div');
  box.className = 'final-section';
  box.id = 'final-section';

  box.innerHTML = `<h3>ğŸ“Š Electivos y Examen de Grado</h3>`;

  const efgB = document.createElement('div');
  efgB.style.marginBottom = '32px';
  efgB.innerHTML = `<h4 style="font-size:0.85rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:12px; font-weight:700;">OFG (${ofgReq} crÃ©ditos)</h4>`;
  efgB.id = 'efg-block';
  efgExtra.forEach(r => efgB.appendChild(makeEFGRow(r)));
  const addEFG = document.createElement('button');
  addEFG.className = 'add-btn'; addEFG.textContent = '+ AÃ±adir curso OFG';
  addEFG.onclick = () => {
    const r = {id:'e'+(++uid), nombre:'', area:'', crd:10, nota:''};
    efgExtra.push(r); saveEFG();
    document.getElementById('efg-block').insertBefore(makeEFGRow(r), addEFG);
    recalc();
  };
  efgB.appendChild(addEFG);
  box.appendChild(efgB);

  const oprB = document.createElement('div');
  oprB.style.marginBottom = '32px';
  oprB.innerHTML = `<h4 style="font-size:0.85rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:12px; font-weight:700;">OPR (${oprReq} crÃ©ditos)</h4>`;
  oprB.id = 'opr-block';
  oprLic.forEach(r => oprB.appendChild(makeOPRRow(r)));
  const addOPR = document.createElement('button');
  addOPR.className = 'add-btn'; addOPR.textContent = '+ AÃ±adir curso OPR';
  addOPR.onclick = () => {
    const r = {id:'o'+(++uid), nombre:'', crd:10, nota:''};
    oprLic.push(r); saveOPR();
    document.getElementById('opr-block').insertBefore(makeOPRRow(r), addOPR);
    recalc();
  };
  oprB.appendChild(addOPR);
  box.appendChild(oprB);

  const examDiv = document.createElement('div');
  examDiv.className = 'exam-box';
  examDiv.innerHTML = `
    <div class="exam-info">
      <h4>Examen de Grado</h4>
      <p style="font-size:0.85rem; color:var(--text-muted); margin-top:4px;">Nota Final = (0.75 Ã— PPA) + (0.25 Ã— Examen)</p>
    </div>
    <input class="exam-input" type="number" min="1" max="7" step="0.1"
      placeholder="â€”" value="${examGrado!==null?examGrado:''}"
      oninput="setExamen(this.value)" />
  `;
  box.appendChild(examDiv);

  const grid = document.createElement('div');
  grid.className = 'final-grid'; grid.id = 'final-grid';
  box.appendChild(grid);

  return box;
}

function makeEFGRow(r) {
  const div = document.createElement('div');
  div.className='elective-row';
  div.id='efg-'+r.id;

  const nameWrap = document.createElement('div');
  const ni = document.createElement('input'); 
  ni.className='el-input'; ni.type='text'; ni.placeholder='Nombre del curso'; ni.value=r.nombre||'';
  ni.oninput = e => { r.nombre = e.target.value; saveEFG(); };
  
  const simBtn = document.createElement('button');
  simBtn.className = 'btn-link';
  simBtn.textContent = 'Simular';
  simBtn.style.cssText = 'font-size:0.75rem; margin-top:8px; display:block;';
  simBtn.onclick = () => openSim(r.id, r.nombre || 'OFG', 'efg', r.id);
  nameWrap.appendChild(ni);
  nameWrap.appendChild(simBtn);

  const sel = document.createElement('select'); sel.className='el-select';
  sel.innerHTML = '<option value="">â€” Ãrea â€”</option>' + EFG_AREAS.map(a=>`<option ${r.area===a?'selected':''} value="${a}">${a}</option>`).join('');
  sel.onchange = e => { r.area=e.target.value; saveEFG(); };

  const ci=document.createElement('input'); ci.className='el-input'; ci.type='number'; ci.min=1; ci.placeholder='Crd'; ci.value=r.crd||10; ci.style.textAlign='center';
  ci.oninput=e=>{r.crd=parseInt(e.target.value)||0;saveEFG();recalc();};

  const inp = document.createElement('input'); inp.className='el-input'; inp.type='number'; inp.min=1; inp.max=7; inp.step=0.1;
  inp.placeholder='Nota'; inp.value=r.nota||''; inp.style.textAlign='center'; inp.style.fontWeight='600';
  inp.oninput = e => { r.nota=e.target.value; saveEFG(); recalc(); };

  const del = document.createElement('button'); del.className='del-btn'; del.textContent='Ã—';
  del.onclick = () => { 
    efgExtra=efgExtra.filter(x=>x.id!==r.id); 
    saveEFG(); delete simData[r.id]; saveSim(); div.remove(); recalc(); 
  };

  div.appendChild(nameWrap); div.appendChild(sel); div.appendChild(ci); div.appendChild(inp); div.appendChild(del);
  return div;
}

function makeOPRRow(r) {
  const div = document.createElement('div');
  div.className='elective-row four-col'; div.id='opr-'+r.id;
  
  const nameWrap = document.createElement('div');
  const ni=document.createElement('input'); 
  ni.className='el-input'; ni.type='text'; ni.placeholder='Nombre del curso'; ni.value=r.nombre||'';
  ni.oninput=e=>{r.nombre=e.target.value;saveOPR();};
  
  const simBtn = document.createElement('button');
  simBtn.className = 'btn-link';
  simBtn.textContent = 'Simular';
  simBtn.style.cssText = 'font-size:0.75rem; margin-top:8px; display:block;';
  simBtn.onclick = () => openSim(r.id, r.nombre || 'OPR', 'opr', r.id);
  nameWrap.appendChild(ni);
  nameWrap.appendChild(simBtn);

  const ci=document.createElement('input'); ci.className='el-input'; ci.type='number'; ci.min=1; ci.placeholder='Crd'; ci.value=r.crd||10; ci.style.textAlign='center';
  ci.oninput=e=>{r.crd=parseInt(e.target.value)||0;saveOPR();recalc();};
  
  const gi=document.createElement('input'); gi.className='el-input'; gi.type='number'; gi.min=1; gi.max=7; gi.step=0.1; gi.placeholder='Nota'; gi.value=r.nota||''; gi.style.textAlign='center'; gi.style.fontWeight='600';
  gi.oninput=e=>{r.nota=e.target.value;saveOPR();recalc();};
  
  const del=document.createElement('button'); del.className='del-btn'; del.textContent='Ã—';
  del.onclick=()=>{
    oprLic=oprLic.filter(x=>x.id!==r.id); saveOPR(); delete simData[r.id]; saveSim(); div.remove(); recalc();
  };
  
  div.appendChild(nameWrap); div.appendChild(ci); div.appendChild(gi); div.appendChild(del);
  return div;
}

// InteracciÃ³n y actualizaciÃ³n de UI
function setAttemptGrade(code, idx, input) {
  if (!Array.isArray(grades[code])) grades[code] = [''];
  grades[code][idx] = input.value;
  saveGrades();

  const n = parseFloat(input.value);
  const hasN = input.value !== '' && !isNaN(n) && n >= 1 && n <= 7;
  const aprobado = hasN && n >= 4.0;

  input.classList.remove('valid', 'invalid');
  if (hasN) input.classList.add(aprobado ? 'valid' : 'invalid');

  const row = document.getElementById('row-' + code + '-' + idx);
  if (row) {
    row.classList.remove('graded', 'failed');
    if (hasN) row.classList.add(aprobado ? 'graded' : 'failed');
  }

  const st = document.getElementById('status-' + code + '-' + idx);
  if (st) {
    st.className = 'badge ' + (hasN ? (aprobado ? 'badge-success' : 'badge-danger') : 'badge-empty');
    st.textContent = hasN ? (aprobado ? 'Aprobado' : 'Reprobado') : 'Pendiente';
  }

  const retryBtn = document.getElementById('retry-btn-' + code);
  if (retryBtn) {
    const atts = grades[code];
    const lastNota = parseFloat(atts[atts.length - 1]);
    const approvedAlready = atts.some(x => parseFloat(x) >= 4.0);
    retryBtn.style.display = (!isNaN(lastNota) && lastNota >= 1 && lastNota < 4 && !approvedAlready) ? 'block' : 'none';
  }
  recalc();
}

function addAttempt(code) {
  if (!Array.isArray(grades[code])) grades[code] = [];
  grades[code].push('');
  saveGrades();
  const block = document.getElementById('block-' + code);
  if (block && block._rebuild) block._rebuild();
  recalc();
}

function removeAttempt(code, idx) {
  if (!Array.isArray(grades[code])) return;
  grades[code].splice(idx, 1);
  saveGrades();
  const block = document.getElementById('block-' + code);
  if(block && block._rebuild) block._rebuild();
  recalc();
}

let prevExamGrado = null;
function setExamen(val) {
  examGrado = val===''?null:parseFloat(val);
  grades.__exam__=examGrado; saveGrades(); recalc();

  if (examGrado !== null && !isNaN(examGrado) && examGrado >= 1 && examGrado <= 7 && examGrado !== prevExamGrado) {
    prevExamGrado = examGrado;
    if (typeof confetti === 'function') confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    const toast = document.getElementById('toast-felicidades');
    toast.textContent = 'ğŸ‰ Â¡Nota de examen guardada!';
    toast.className = 'show';
    setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3500);
  } else if (examGrado === null || isNaN(examGrado)) {
    prevExamGrado = null;
  }
}

function formatReq(n) {
  if (n <= 1) return 'Logrado (MÃ­n 1.0)';
  if (n > 7) return n.toFixed(2) + ' (Imposible)';
  return n.toFixed(2);
}

// Simulador
function openSim(code, name, type, targetId) {
  currentSimCourse = {code, name, type, targetId};
  if(!simData[code] || Array.isArray(simData[code])) {
    simData[code] = {
      hasExam: false, examWeight: 30, eximGrade: 5.0,
      evals: Array.isArray(simData[code]) ? simData[code] : [
        {name:'InterrogaciÃ³n 1', weight:30, grade:''},
        {name:'InterrogaciÃ³n 2', weight:30, grade:''},
        {name:'Tareas', weight:40, grade:''}
      ],
      examGrade: ''
    };
  }
  const data = simData[code];
  document.getElementById('sim-title').textContent = name;
  document.getElementById('sim-chk-exam').checked = data.hasExam;
  document.getElementById('sim-exam-details').style.display = data.hasExam ? 'grid' : 'none';
  document.getElementById('sim-inp-exam-weight').value = data.examWeight;
  document.getElementById('sim-inp-exam-exim').value = data.eximGrade;
  document.getElementById('sim-inp-exam-grade').value = data.examGrade || '';
  renderSim();
  document.getElementById('sim-modal').style.display = 'flex';
}

function closeSim() { document.getElementById('sim-modal').style.display = 'none'; }
function toggleSimExam() {
  const isChecked = document.getElementById('sim-chk-exam').checked;
  simData[currentSimCourse.code].hasExam = isChecked;
  document.getElementById('sim-exam-details').style.display = isChecked ? 'grid' : 'none';
  saveSim(); calcSimTotals();
}

function updateSimConfig() {
  simData[currentSimCourse.code].examWeight = parseFloat(document.getElementById('sim-inp-exam-weight').value) || 0;
  simData[currentSimCourse.code].eximGrade = parseFloat(document.getElementById('sim-inp-exam-exim').value) || 5.0;
  saveSim(); calcSimTotals();
}

function updateSimExamGrade() {
  simData[currentSimCourse.code].examGrade = document.getElementById('sim-inp-exam-grade').value;
  saveSim(); calcSimTotals();
}

function renderSim() {
  const container = document.getElementById('sim-rows');
  container.innerHTML = '';
  simData[currentSimCourse.code].evals.forEach((item, i) => {
    const div = document.createElement('div');
    div.className = 'sim-row';
    div.innerHTML = `
      <input class="sim-input" type="text" placeholder="Control 1" value="${item.name}" oninput="updateSim(${i}, 'name', this.value)" style="text-align:left;">
      <input class="sim-input" type="number" min="0" max="100" placeholder="%" value="${item.weight}" oninput="updateSim(${i}, 'weight', this.value)">
      <input class="sim-input" type="number" min="1" max="7" step="0.1" placeholder="Nota" value="${item.grade}" oninput="updateSim(${i}, 'grade', this.value)" style="font-weight:600;">
      <button class="del-btn" onclick="delSim(${i})">Ã—</button>
    `;
    container.appendChild(div);
  });
  calcSimTotals();
}

function updateSim(idx, field, val) { simData[currentSimCourse.code].evals[idx][field] = val; saveSim(); calcSimTotals(); }
function addSimRow() { simData[currentSimCourse.code].evals.push({name:'', weight:'', grade:''}); saveSim(); renderSim(); }
function delSim(idx) { simData[currentSimCourse.code].evals.splice(idx, 1); saveSim(); renderSim(); }
function saveSim() { localStorage.setItem('ppa4-sim-'+currentCareer, JSON.stringify(simData)); }

function calcSimTotals() {
  const data = simData[currentSimCourse.code];
  let wSum = 0; let npAccum = 0;
  data.evals.forEach(ev => {
    let w = parseFloat(ev.weight) || 0; let g = parseFloat(ev.grade);
    wSum += w;
    if(!isNaN(g) && g >= 1 && g <= 7) npAccum += g * (w / 100);
  });
  const wMissing = Math.max(0, 100 - wSum);
  let resHTML = `<p style="margin-bottom:12px;">Suma de ponderaciones: <span style="font-weight:700; color:${wSum>100?'var(--danger)':'var(--text-main)'}">${wSum}% / 100%</span></p>`;

  if (wSum < 100) {
    let currentAvg = wSum > 0 ? (npAccum / (wSum/100)).toFixed(2) : 'â€”';
    resHTML += `<p style="margin-bottom:8px;">Promedio parcial: <strong style="color:var(--text-main); font-size:1.1rem;">${currentAvg}</strong></p>`;
    let missingFor4 = 4.0 - npAccum; let req4 = missingFor4 / (wMissing / 100);
    resHTML += `<p style="margin-bottom:8px;">Para aprobar (4.0) necesitas: <strong style="color:var(--warning);">${formatReq(req4)}</strong> en el resto.</p>`;
    if (data.hasExam) {
      let missingForExim = data.eximGrade - npAccum; let reqExim = missingForExim / (wMissing / 100);
      resHTML += `<p>Para eximirte (NP ${data.eximGrade}) necesitas: <strong style="color:var(--primary);">${formatReq(reqExim)}</strong></p>`;
    }
    document.getElementById('sim-exam-grade-box').style.display = 'none';
  } else if (wSum === 100) {
    let np = npAccum;
    resHTML += `<p style="margin-bottom:12px;">Nota de PresentaciÃ³n (NP): <strong style="font-size:1.2rem; color:var(--text-main);">${np.toFixed(2)}</strong></p>`;
    if (!data.hasExam) {
      resHTML += `<div style="padding-top:12px; border-top:1px solid var(--border-subtle);"><p>Nota Final del Ramo: <strong style="color:${np>=4?'var(--success)':'var(--danger)'}; font-size:1.4rem;">${np.toFixed(1)}</strong></p></div>`;
      document.getElementById('sim-exam-grade-box').style.display = 'none';
    } else {
      if (np >= data.eximGrade) {
        resHTML += `<div style="padding-top:12px; border-top:1px solid var(--border-subtle);"><p style="color:var(--success); font-weight:700; margin-bottom:4px;">ğŸ‰ Â¡Te eximiste del examen!</p>`;
        resHTML += `<p>Nota Final del Ramo: <strong style="color:var(--success); font-size:1.4rem;">${np.toFixed(1)}</strong></p></div>`;
        document.getElementById('sim-exam-grade-box').style.display = 'none';
      } else {
        resHTML += `<div style="padding-top:12px; border-top:1px solid var(--border-subtle);"><p style="color:var(--warning); font-weight:700; margin-bottom:8px;">âš ï¸ No lograste eximirte.</p>`;
        let ew = data.examWeight / 100; let reqExam = (4.0 - np * (1 - ew)) / ew;
        resHTML += `<p>Necesitas un <strong style="color:var(--danger);">${formatReq(reqExam)}</strong> en el examen para el 4.0.</p></div>`;
        document.getElementById('sim-exam-grade-box').style.display = 'block';
        let gEx = parseFloat(data.examGrade);
        if (!isNaN(gEx) && gEx >= 1 && gEx <= 7) {
          let nf = np * (1 - ew) + gEx * ew;
          resHTML += `<div style="padding-top:16px; margin-top:16px; border-top:1px dashed var(--border-subtle);"><p>Nota Final del Ramo: <strong style="color:${nf>=4?'var(--success)':'var(--danger)'}; font-size:1.4rem;">${nf.toFixed(1)}</strong></p></div>`;
        }
      }
    }
  } else {
    resHTML += `<p style="color:var(--danger); font-weight:700;">Tus evaluaciones superan el 100%.</p>`;
    document.getElementById('sim-exam-grade-box').style.display = 'none';
  }
  document.getElementById('sim-results-content').innerHTML = resHTML;
}

function useSimGrade() {
  const data = simData[currentSimCourse.code];
  let wSum = 0; let npAccum = 0;
  data.evals.forEach(ev => {
    let w = parseFloat(ev.weight)||0; let g = parseFloat(ev.grade);
    wSum += w; if(!isNaN(g) && g>=1 && g<=7) npAccum += g*(w/100);
  });
  if (wSum !== 100) { alert('Ajusta los porcentajes al 100% para guardar la nota.'); return; }
  
  let finalGrade = 0;
  if (!data.hasExam) { finalGrade = npAccum; } 
  else {
    if (npAccum >= data.eximGrade) finalGrade = npAccum;
    else {
      let ex = parseFloat(data.examGrade);
      if (isNaN(ex) || ex < 1 || ex > 7) { alert('Ingresa la nota del examen para calcular tu final.'); return; }
      let ew = data.examWeight / 100; finalGrade = npAccum * (1 - ew) + ex * ew;
    }
  }
  
  const finalStr = finalGrade.toFixed(1);
  
  if (currentSimCourse.type === 'malla') {
    const idx = currentSimCourse.targetId;
    const inp = document.querySelector(`#row-${currentSimCourse.code}-${idx} .grade-input`);
    if (inp) { inp.value = finalStr; setAttemptGrade(currentSimCourse.code, idx, inp); } 
    else {
      if(!Array.isArray(grades[currentSimCourse.code])) grades[currentSimCourse.code] = [''];
      grades[currentSimCourse.code][idx] = finalStr; saveGrades();
      const block = document.getElementById('block-' + currentSimCourse.code);
      if(block) block._rebuild(); recalc();
    }
  } else if (currentSimCourse.type === 'efg') {
    const item = efgExtra.find(x => x.id === currentSimCourse.targetId);
    if (item) {
      item.nota = finalStr; saveEFG();
      document.querySelectorAll(`#efg-${item.id} input.el-input`).forEach(i => { if(i.placeholder === 'Nota') i.value = finalStr; });
      recalc();
    }
  } else if (currentSimCourse.type === 'opr') {
    const item = oprLic.find(x => x.id === currentSimCourse.targetId);
    if (item) {
      item.nota = finalStr; saveOPR();
      document.querySelectorAll(`#opr-${item.id} input.el-input`).forEach(i => { if(i.placeholder === 'Nota') i.value = finalStr; });
      recalc();
    }
  }
  closeSim();
}

function recalc() {
  let sumP=0, sumC=0, apr=0, rep=0, aprCrdTotal=0;
  MALLA.forEach(yr=>yr.sems.forEach(sem=>sem.cursos.forEach(c=>{
    if(c.noGrade) return;
    const atts = Array.isArray(grades[c.code]) ? grades[c.code] : [];
    atts.forEach(nota => {
      const n = parseFloat(nota);
      if(isNaN(n)||n<1||n>7) return;
      sumP+=n*c.crd; sumC+=c.crd;
      if (n >= 4) { apr++; aprCrdTotal += c.crd; } else { rep++; }
    });
  })));

  efgExtra.forEach(r=>{
    const n=parseFloat(r.nota), crd=parseInt(r.crd)||0;
    if(isNaN(n)||n<1||n>7||crd<=0) return;
    sumP+=n*crd; sumC+=crd; 
    if (n >= 4) { apr++; aprCrdTotal += crd; } else { rep++; }
  });

  oprLic.forEach(r=>{
    const n=parseFloat(r.nota), crd=parseInt(r.crd)||0;
    if(isNaN(n)||n<1||n>7||crd<=0) return;
    sumP+=n*crd; sumC+=crd; 
    if (n >= 4) { apr++; aprCrdTotal += crd; } else { rep++; }
  });

  const ppa = sumC>0 ? sumP/sumC : null;
  const examN = examGrado!==null&&!isNaN(examGrado)&&examGrado>=1&&examGrado<=7 ? examGrado : null;
  const notaLic = ppa!==null&&examN!==null ? (0.75*ppa)+(0.25*examN) : null;
  const progress = Math.min(100, (aprCrdTotal / 410) * 100);

  const pe=document.getElementById('stat-ppa');
  if(ppa!==null){ 
    pe.textContent=ppa.toFixed(2); 
    pe.style.color = ppa>=5.5 ? 'var(--success)' : (ppa>=4.5 ? 'var(--warning)' : 'var(--danger)');
  } else { 
    pe.textContent='â€”'; 
    pe.style.color = 'var(--text-main)';
  }
  
  document.getElementById('stat-crd').textContent=sumC;
  document.getElementById('stat-apr').textContent=apr;
  document.getElementById('stat-rep').textContent=rep;
  
  // Actualizar la nueva barra de progreso visual
  document.getElementById('stat-prog-text').textContent=progress.toFixed(1) + '%';
  document.getElementById('stat-prog-fill').style.width = progress + '%';

  const grid=document.getElementById('final-grid');
  if(grid) grid.innerHTML=`
    <div class="final-box" style="background: var(--surface); color: var(--text-main); border: 1px solid var(--border-subtle); box-shadow: var(--shadow-sm);">
      <div class="fl" style="color:var(--text-muted);">PPA Licenciatura</div>
      <div class="fn">${ppa!==null?ppa.toFixed(2):'â€”'}</div>
      <div class="formula" style="color:var(--text-muted);">${sumC} crÃ©ditos evaluados</div>
    </div>
    <div class="final-box">
      <div class="fl">Nota Final Licenciatura</div>
      <div class="fn">${notaLic!==null?notaLic.toFixed(2):(ppa!==null?'Falta examen':'â€”')}</div>
    </div>
  `;
}

function saveGrades(){ localStorage.setItem('ppa4-g-'+currentCareer, JSON.stringify(grades)); }
function saveEFG()   { localStorage.setItem('ppa4-efg-'+currentCareer, JSON.stringify(efgExtra)); }
function saveOPR()   { localStorage.setItem('ppa4-opr-'+currentCareer, JSON.stringify(oprLic)); }

function resetAll(){
  if(!confirm('Â¿Seguro que quieres borrar todos los datos ingresados?')) return;
  grades={}; efgExtra=[]; oprLic=[]; examGrado=null; simData={};
  localStorage.removeItem('ppa4-g-'+currentCareer);
  localStorage.removeItem('ppa4-efg-'+currentCareer);
  localStorage.removeItem('ppa4-opr-'+currentCareer);
  localStorage.removeItem('ppa4-sim-'+currentCareer);
  renderCalc();
}
</script>
</body>
</html>
<a href="https://cacbiouc.github.io/CACBIOUC/" 
   style="display: inline-block; margin: 10px; padding: 10px 20px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 8px; font-size: 16px; font-family: Arial, sans-serif;">
  ğŸ  Volver al Portal Estudiantil
</a>
